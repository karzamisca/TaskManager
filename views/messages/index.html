<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Private Message Rooms</title>
    <style>
      /* Add to existing styles */
      .room-list {
        margin: 20px 0;
        display: grid;
        gap: 10px;
      }

      .room-card {
        background-color: var(--message-bg-color);
        border: 1px solid var(--message-border-color);
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
      }

      .room-card:hover {
        background-color: var(--message-hover-bg-color);
      }

      .room-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: var(--form-bg-color);
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
      }

      .close {
        float: right;
        cursor: pointer;
        font-size: 1.5rem;
      }

      .user-select {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        background-color: var(--textarea-bg-color);
        color: var(--textarea-text-color);
        border: 1px solid var(--textarea-border-color);
        border-radius: 4px;
      }

      .room-messages {
        display: none;
        margin-top: 20px;
      }

      .back-to-rooms {
        margin-bottom: 10px;
        display: inline-block;
      }

      .member-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .creator-badge {
        color: green;
        font-weight: bold;
      }

      .header {
        background-color: var(--form-bg-color);
        padding: 15px;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--message-border-color);
        display: flex;
        gap: 20px;
      }

      .header a {
        color: var(--textarea-text-color);
        text-decoration: none;
        padding: 8px 12px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }

      .header a:hover {
        background-color: var(--message-hover-bg-color);
      }
    </style>
  </head>
  <body>
    <div class="header">
      <a href="/main">Trở về trang chính/Back to main</a>
      <a href="/changePassword">Đổi mật khẩu / Change password</a>
      <a href="/logout">Đăng xuất / Logout</a>
    </div>

    <h1>Bảng Tin Nhắn/Message Board</h1>

    <!-- Room List View -->
    <div id="rooms-view">
      <button id="create-room-btn" onclick="showCreateRoomModal()">
        Tạo phòng mới/Create New Room
      </button>
      <div class="room-list" id="room-list"></div>
    </div>

    <!-- Room Messages View -->
    <div id="room-messages-view" class="room-messages">
      <a href="#" class="back-to-rooms" onclick="showRoomList()">
        ← Trở lại danh sách phòng/Back to Rooms
      </a>
      <h2 id="current-room-name"></h2>
      <div id="room-messages"></div>
      <form id="room-message-form">
        <textarea
          name="content"
          id="room-content"
          rows="4"
          placeholder="Nhập tin nhắn/Write a message..."
          required
        ></textarea>
        <button type="submit">Đăng tin nhắn/Post Message</button>
      </form>
    </div>

    <!-- Create Room Modal -->
    <div id="create-room-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="hideCreateRoomModal()">&times;</span>
        <h2>Tạo phòng mới/Create New Room</h2>
        <form id="create-room-form">
          <input
            type="text"
            id="room-name"
            placeholder="Tên phòng/Room Name"
            required
            class="user-select"
          />
          <select id="room-members" multiple class="user-select" required>
            <!-- Users will be populated here -->
          </select>
          <button type="submit">Tạo/Create</button>
        </form>
      </div>
    </div>

    <!-- Manage Room Modal -->
    <div id="manage-room-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="hideManageRoomModal()">&times;</span>
        <h2>Quản lý phòng/Manage Room</h2>

        <!-- Add New Members Form -->
        <form id="add-members-form">
          <select id="new-members" multiple class="user-select">
            <!-- Users will be populated here -->
          </select>
          <button type="submit">Thêm thành viên/Add Members</button>
        </form>

        <!-- Current Members List -->
        <div id="current-members"></div>

        <!-- Delete Room Button -->
        <button onclick="deleteRoom(currentRoomId)">
          Xóa phòng/Delete Room
        </button>
      </div>
    </div>

    <script>
      let currentRoomId = null;

      // Initialize the room functionality
      document.addEventListener("DOMContentLoaded", function () {
        fetchRooms();
        setupCreateRoomForm();
        setupRoomMessageForm();
        setupAddMembersForm();
      });

      // Fetch and display rooms
      function fetchRooms() {
        fetch("/rooms")
          .then((response) => response.json())
          .then((rooms) => {
            const roomList = document.getElementById("room-list");
            roomList.innerHTML = "";

            rooms.forEach((room) => {
              const roomCard = document.createElement("div");
              roomCard.className = "room-card";
              roomCard.onclick = () => openRoom(room._id, room.name);

              roomCard.innerHTML = `
                <div class="room-header">
                  <strong>${room.name}</strong>
                  <small>${room.members.length} members</small>
                  <button onclick="showManageRoomModal('${room._id}')">Quản lý/Manage</button>
                </div>
                <small>Created by: ${room.creator.username}</small>
              `;

              roomList.appendChild(roomCard);
            });
          })
          .catch((err) => console.error("Error fetching rooms:", err));
      }

      // Open a specific room
      function openRoom(roomId, roomName) {
        currentRoomId = roomId;
        document.getElementById("rooms-view").style.display = "none";
        document.getElementById("room-messages-view").style.display = "block";
        document.getElementById("current-room-name").textContent = roomName;
        fetchRoomMessages(roomId);
      }

      // Fetch room messages
      function fetchRoomMessages(roomId) {
        fetch(`/room/${roomId}/messages`)
          .then((response) => response.json())
          .then((messages) => {
            const messageList = document.getElementById("room-messages");
            messageList.innerHTML = "";

            messages.forEach((message) => {
              const messageItem = document.createElement("div");
              messageItem.className = "message";
              messageItem.innerHTML = `
                <strong>${message.user.username}</strong>: ${message.content}
                <small>(${message.createdAt})</small>
              `;
              messageList.appendChild(messageItem);
            });
          })
          .catch((err) => console.error("Error fetching room messages:", err));
      }

      // Show room list
      function showRoomList() {
        currentRoomId = null;
        document.getElementById("rooms-view").style.display = "block";
        document.getElementById("room-messages-view").style.display = "none";
      }

      // Setup room message form
      function setupRoomMessageForm() {
        const form = document.getElementById("room-message-form");
        form.onsubmit = function (e) {
          e.preventDefault();
          const content = document.getElementById("room-content").value;

          if (content.trim() && currentRoomId) {
            fetch("/room/message", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                roomId: currentRoomId,
                content: content,
              }),
            })
              .then(() => {
                document.getElementById("room-content").value = "";
                fetchRoomMessages(currentRoomId);
              })
              .catch((err) => console.error("Error posting message:", err));
          }
        };
      }

      // Modal functions
      function showCreateRoomModal() {
        document.getElementById("create-room-modal").style.display = "block";
        fetchUsers();
      }

      function hideCreateRoomModal() {
        document.getElementById("create-room-modal").style.display = "none";
      }

      // Fetch users for room creation
      function fetchUsers() {
        fetch("/users")
          .then((response) => response.json())
          .then((users) => {
            const select = document.getElementById("room-members");
            select.innerHTML = "";

            users.forEach((user) => {
              const option = document.createElement("option");
              option.value = user._id;
              option.textContent = user.username;
              select.appendChild(option);
            });
          })
          .catch((err) => console.error("Error fetching users:", err));
      }

      // Setup create room form
      function setupCreateRoomForm() {
        const form = document.getElementById("create-room-form");
        form.onsubmit = function (e) {
          e.preventDefault();
          const name = document.getElementById("room-name").value;
          const memberSelect = document.getElementById("room-members");
          const memberIds = Array.from(memberSelect.selectedOptions).map(
            (option) => option.value
          );

          fetch("/room/create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name: name,
              memberIds: memberIds,
            }),
          })
            .then(() => {
              hideCreateRoomModal();
              fetchRooms();
              form.reset();
            })
            .catch((err) => console.error("Error creating room:", err));
        };
      }

      // Room management functions
      function showManageRoomModal(roomId) {
        event.stopPropagation(); // Prevent room opening
        currentRoomId = roomId;
        document.getElementById("manage-room-modal").style.display = "block";
        fetchRoomMembers(roomId);
        fetchUsersForAdding();
      }

      function hideManageRoomModal() {
        document.getElementById("manage-room-modal").style.display = "none";
      }

      // Fetch users for the "Add Members" dropdown
      function fetchUsersForAdding() {
        fetch("/users")
          .then((response) => response.json())
          .then((users) => {
            const select = document.getElementById("new-members");
            select.innerHTML = "";

            users.forEach((user) => {
              const option = document.createElement("option");
              option.value = user._id;
              option.textContent = user.username;
              select.appendChild(option);
            });
          })
          .catch((err) => console.error("Error fetching users:", err));
      }

      // Fetch and display current room members
      function fetchRoomMembers(roomId) {
        fetch(`/room/${roomId}/members`)
          .then((response) => response.json())
          .then((members) => {
            const memberList = document.getElementById("current-members");
            memberList.innerHTML = "";

            members.forEach((member) => {
              const memberItem = document.createElement("div");
              memberItem.className = "member-item";
              memberItem.innerHTML = `
                <span>${member.username} (${member.department})</span>
                ${
                  member._id !== room.creator
                    ? `<button onclick="removeMember('${member._id}')">Xóa/Remove</button>`
                    : '<span class="creator-badge">Người tạo/Creator</span>'
                }
              `;
              memberList.appendChild(memberItem);
            });
          })
          .catch((err) => console.error("Error fetching room members:", err));
      }

      // Add new members to the room
      function addMembersToRoom() {
        const memberSelect = document.getElementById("new-members");
        const memberIds = Array.from(memberSelect.selectedOptions).map(
          (option) => option.value
        );

        if (!currentRoomId || memberIds.length === 0) return;

        fetch("/room/members/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            roomId: currentRoomId,
            memberIds: memberIds,
          }),
        })
          .then(() => {
            fetchRoomMembers(currentRoomId); // Refresh the members list
            fetchRooms(); // Update the room list
          })
          .catch((err) => console.error("Error adding members:", err));
      }

      // Remove a member from the room
      function removeMember(memberId) {
        if (!currentRoomId) return;

        fetch("/room/members/remove", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            roomId: currentRoomId,
            memberId: memberId,
          }),
        })
          .then(() => {
            fetchRoomMembers(currentRoomId); // Refresh the members list
            fetchRooms(); // Update the room list
          })
          .catch((err) => console.error("Error removing member:", err));
      }

      // Delete the room
      function deleteRoom(roomId) {
        if (
          !confirm(
            "Bạn có chắc muốn xóa phòng này?/Are you sure you want to delete this room?"
          )
        )
          return;

        fetch(`/room/${roomId}`, {
          method: "DELETE",
        })
          .then(() => {
            hideManageRoomModal();
            showRoomList();
            fetchRooms();
          })
          .catch((err) => console.error("Error deleting room:", err));
      }

      // Setup the "Add Members" form
      function setupAddMembersForm() {
        const form = document.getElementById("add-members-form");
        form.onsubmit = function (e) {
          e.preventDefault();
          addMembersToRoom();
        };
      }
    </script>
  </body>
</html>
