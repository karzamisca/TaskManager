<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bảng Doanh Thu</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
      rel="stylesheet"
    />
    <style>
      .positive {
        color: green;
      }
      .negative {
        color: red;
      }
      .na-value {
        color: #6c757d;
        font-style: italic;
      }
      .select2-container--bootstrap-5 .select2-selection {
        min-height: 38px;
      }
      .dt-buttons .btn {
        margin-right: 5px;
      }
      .dataTables_wrapper .dt-buttons {
        float: right;
        margin-bottom: 15px;
      }
      .dataTables_info {
        padding-top: 0.85em !important;
      }
      .budget-summary {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
      }
      .budget-summary h5 {
        margin-bottom: 15px;
      }
      .budget-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .budget-total {
        font-weight: bold;
        border-top: 1px solid #dee2e6;
        padding-top: 10px;
        margin-top: 10px;
      }
      .group-item:hover {
        background-color: #f8f9fa;
        cursor: pointer;
      }
      .metric-row {
        font-weight: bold;
      }
      .metric-row td:first-child {
        background-color: #f8f9fa;
        border-right: 2px solid #dee2e6;
      }
      .center-header {
        background-color: #e9ecef;
        font-weight: bold;
        text-align: center;
      }
      .month-subheader {
        background-color: #f8f9fa;
        font-size: 0.9em;
        text-align: center;
      }
      .pivot-table {
        font-size: 0.9em;
      }
      .pivot-table th {
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .pivot-table td:first-child {
        position: sticky;
        left: 0;
        z-index: 5;
        background-color: #f8f9fa;
      }
      .table-container {
        max-height: 600px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid mt-4">
      <h1 class="mb-4">Bảng Doanh Thu</h1>

      <div class="card mb-4">
        <div class="card-body">
          <form id="filterForm">
            <div class="row">
              <div class="col-md-4">
                <label for="yearSelect" class="form-label">Năm</label>
                <select class="form-select" id="yearSelect"></select>
              </div>
              <div class="col-md-6">
                <label for="costCenterSelect" class="form-label">Trạm</label>
                <select
                  class="form-select"
                  id="costCenterSelect"
                  multiple="multiple"
                >
                  <option value="all">Tất Cả Trạm</option>
                </select>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <div class="d-grid w-100">
                  <button type="submit" class="btn btn-primary">Áp dụng</button>
                  <div class="d-flex justify-content-between mt-2">
                    <button
                      type="button"
                      class="btn btn-outline-secondary btn-sm"
                      id="clearSelection"
                    >
                      Xóa chọn
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-primary btn-sm"
                      id="manageGroups"
                      data-bs-toggle="modal"
                      data-bs-target="#groupModal"
                    >
                      Nhóm trạm
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="mb-3">
            <small class="text-muted" id="selectedCentersInfo"></small>
          </div>
          <div class="table-container">
            <table
              id="revenueTable"
              class="table table-striped table-bordered pivot-table"
              style="width: 100%"
            >
              <thead id="tableHead">
                <!-- Dynamic header will be inserted here -->
              </thead>
              <tbody id="tableBody">
                <!-- Dynamic body will be inserted here -->
              </tbody>
            </table>
          </div>

          <div
            id="budgetSummaryContainer"
            class="budget-summary mt-4"
            style="display: none"
          >
            <h5>Tổng hợp ngân sách 2025</h5>
            <div id="budgetDetails">
              <!-- Budget details will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Group Management Modal -->
    <div class="modal fade" id="groupModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Quản lý nhóm trạm</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="groupName" class="form-label">Tên nhóm</label>
                  <input type="text" class="form-control" id="groupName" />
                </div>
                <div class="mb-3">
                  <label for="groupCostCenters" class="form-label"
                    >Chọn trạm</label
                  >
                  <select
                    class="form-select"
                    id="groupCostCenters"
                    multiple="multiple"
                  ></select>
                </div>
                <button
                  type="button"
                  class="btn btn-primary w-100"
                  id="saveGroup"
                >
                  Lưu nhóm
                </button>
              </div>
              <div class="col-md-6">
                <h6>Nhóm trạm của bạn:</h6>
                <div
                  id="groupList"
                  class="list-group mt-2"
                  style="max-height: 300px; overflow-y: auto"
                >
                  <div class="list-group-item text-muted text-center">
                    Đang tải nhóm...
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="/components/header/headerLoader.js?v=1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
    <script>
      $(document).ready(function () {
        // Constants
        const STARTING_BUDGET_2025 = 2866850896;

        // Month mapping for proper sorting
        const monthOrder = {
          "Tháng Một": 1,
          "Tháng Hai": 2,
          "Tháng Ba": 3,
          "Tháng Tư": 4,
          "Tháng Năm": 5,
          "Tháng Sáu": 6,
          "Tháng Bảy": 7,
          "Tháng Tám": 8,
          "Tháng Chín": 9,
          "Tháng Mười": 10,
          "Tháng Mười Một": 11,
          "Tháng Mười Hai": 12,
        };

        // Metrics configuration
        const metrics = [
          { key: "totalSale", label: "Tổng Bán Hàng", isPositive: true },
          { key: "totalPurchase", label: "Tổng Mua Hàng", isPositive: false },
          {
            key: "totalTransport",
            label: "Chi Phí Vận Chuyển",
            isPositive: false,
          },
          {
            key: "totalCommissionPurchase",
            label: "Hoa Hồng Mua Hàng",
            isPositive: false,
          },
          {
            key: "totalCommissionSale",
            label: "Hoa Hồng Bán Hàng",
            isPositive: false,
          },
          { key: "totalSalary", label: "Tổng Lương", isPositive: false },
          { key: "totalPayments", label: "Tổng Thanh Toán", isPositive: false },
          { key: "netRevenue", label: "Doanh Thu Ròng", isPositive: true },
        ];

        let currentTable = null;

        // Initialize Select2 for cost center selection
        $("#costCenterSelect").select2({
          theme: "bootstrap-5",
          placeholder: "Chọn trạm...",
          allowClear: true,
          closeOnSelect: false,
          width: "100%",
        });

        // Populate year dropdown
        const currentYear = new Date().getFullYear();
        const yearSelect = $("#yearSelect");

        for (let year = currentYear; year >= currentYear - 5; year--) {
          yearSelect.append(`<option value="${year}">${year}</option>`);
        }

        yearSelect.val(currentYear);

        // Fetch cost centers and populate dropdown
        $.ajax({
          url: "/financeSummaryCostCenters",
          method: "GET",
          success: function (data) {
            const costCenterSelect = $("#costCenterSelect");
            data.forEach((costCenter) => {
              costCenterSelect.append(
                `<option value="${costCenter.name}">${costCenter.name}</option>`
              );
            });

            // Set default to "all" and trigger Select2 update
            costCenterSelect.val(["all"]).trigger("change");
          },
          error: function () {
            console.error("Không thể tải danh sách trạm");
            alert("Lỗi khi tải danh sách trạm");
          },
        });

        // Handle "Tất Cả Trạm" selection logic
        $("#costCenterSelect").on("change", function () {
          const selectedValues = $(this).val();

          if (selectedValues && selectedValues.includes("all")) {
            // If "all" is selected, clear other selections
            if (selectedValues.length > 1) {
              $(this).val(["all"]).trigger("change");
            }
          }
        });

        // Clear selection button
        $("#clearSelection").on("click", function () {
          $("#costCenterSelect").val(["all"]).trigger("change");
        });

        // Update selected centers info
        function updateSelectedCentersInfo() {
          const selectedValues = $("#costCenterSelect").val();
          const infoElement = $("#selectedCentersInfo");

          if (
            !selectedValues ||
            selectedValues.length === 0 ||
            selectedValues.includes("all")
          ) {
            infoElement.text("Hiển thị: Tất cả trạm");
          } else {
            infoElement.text(
              `Hiển thị: ${
                selectedValues.length
              } trạm được chọn (${selectedValues.join(", ")})`
            );
          }
        }

        $("#costCenterSelect").on("change", updateSelectedCentersInfo);

        // Function to create pivot table
        function createPivotTable(data) {
          // Destroy existing DataTable if it exists
          if (currentTable) {
            currentTable.destroy();
            currentTable = null;
          }

          // Group data by cost center and month
          const pivotData = {};
          const costCenters = new Set();
          const months = new Set();

          data.forEach((item) => {
            const centerMonthKey = `${item.costCenter}_${item.actualMonth}_${item.actualYear}`;
            costCenters.add(item.costCenter);
            months.add(`${item.actualMonth} ${item.actualYear}`);

            if (!pivotData[centerMonthKey]) {
              pivotData[centerMonthKey] = {
                costCenter: item.costCenter,
                month: `${item.actualMonth} ${item.actualYear}`,
                monthOrder: monthOrder[item.actualMonth] || 0,
                year: item.actualYear,
                totalSale: 0,
                totalPurchase: 0,
                totalTransport: 0,
                totalCommissionPurchase: 0,
                totalCommissionSale: 0,
                totalSalary: 0,
                totalPayments: 0,
                netRevenue: 0,
              };
            }

            const entry = pivotData[centerMonthKey];
            entry.totalSale += item.totalSale;
            entry.totalPurchase += item.totalPurchase;
            entry.totalTransport += item.totalTransport;
            entry.totalCommissionPurchase += item.totalCommissionPurchase;
            entry.totalCommissionSale += item.totalCommissionSale;
            entry.totalSalary += item.grossSalary;
            entry.totalPayments += item.totalPayments;
            entry.netRevenue =
              entry.totalSale -
              entry.totalPurchase -
              entry.totalTransport -
              entry.totalCommissionPurchase -
              entry.totalCommissionSale -
              entry.totalSalary -
              entry.totalPayments;
          });

          // Sort cost centers and months
          const sortedCostCenters = Array.from(costCenters).sort();
          const sortedMonths = Array.from(months).sort((a, b) => {
            const [monthA, yearA] = a.split(" ");
            const [monthB, yearB] = b.split(" ");
            const yearDiff = parseInt(yearA) - parseInt(yearB);
            if (yearDiff !== 0) return yearDiff;
            return (monthOrder[monthA] || 0) - (monthOrder[monthB] || 0);
          });

          // Create table header
          const tableHead = $("#tableHead");
          tableHead.empty();

          const headerRow = $("<tr></tr>");
          headerRow.append(
            '<th rowspan="2" class="metric-row" style="min-width: 180px; width: 180px;">Chi tiêu</th>'
          );

          sortedCostCenters.forEach((center) => {
            headerRow.append(
              `<th colspan="${sortedMonths.length}" class="center-header">${center}</th>`
            );
          });

          const subHeaderRow = $("<tr></tr>");
          sortedCostCenters.forEach((center) => {
            sortedMonths.forEach((month) => {
              subHeaderRow.append(
                `<th class="month-subheader" style="min-width: 120px;">${month}</th>`
              );
            });
          });

          tableHead.append(headerRow);
          tableHead.append(subHeaderRow);

          // Create table body
          const tableBody = $("#tableBody");
          tableBody.empty();

          metrics.forEach((metric) => {
            const row = $('<tr class="metric-row"></tr>');
            row.append(
              `<td style="min-width: 180px; width: 180px;">${metric.label}</td>`
            );

            sortedCostCenters.forEach((center) => {
              sortedMonths.forEach((month) => {
                const centerMonthKey = `${center}_${month.replace(" ", "_")}`;
                const entry = Object.values(pivotData).find(
                  (item) => item.costCenter === center && item.month === month
                );

                let value = 0;
                if (entry) {
                  value = entry[metric.key];
                }

                let cellClass = "";
                if (metric.isPositive && value > 0) cellClass = "positive";
                else if (!metric.isPositive && value > 0)
                  cellClass = "negative";
                else if (value < 0) cellClass = "negative";

                const formattedValue =
                  value === 0 ? "-" : value.toLocaleString("vi-VN");
                row.append(
                  `<td class="${cellClass}" style="min-width: 120px; text-align: right;">${formattedValue}</td>`
                );
              });
            });

            tableBody.append(row);
          });

          // Wait for DOM to be ready before initializing DataTable
          setTimeout(() => {
            // Initialize DataTable with specific configuration for pivot table
            currentTable = $("#revenueTable").DataTable({
              responsive: false,
              scrollX: true,
              scrollY: "500px",
              paging: false,
              searching: false,
              ordering: false,
              info: false,
              autoWidth: false,
              fixedColumns: {
                leftColumns: 1,
              },
              dom: "Bt",
              buttons: [
                {
                  extend: "excelHtml5",
                  text: "Xuất Excel",
                  className: "btn btn-success",
                  title: "Báo cáo doanh thu",
                  filename: function () {
                    const year = $("#yearSelect").val();
                    const selectedCostCenters = $("#costCenterSelect").val();
                    let fileName = `Bao_cao_doanh_thu_${year}`;

                    if (
                      selectedCostCenters &&
                      selectedCostCenters.length > 0 &&
                      !selectedCostCenters.includes("all")
                    ) {
                      fileName += `_${selectedCostCenters.join("_")}`;
                    }

                    return fileName;
                  },
                  customize: function (xlsx) {
                    const sheet = xlsx.xl.worksheets["sheet1.xml"];

                    // Add header information
                    const year = $("#yearSelect").val();
                    const selectedCostCenters = $("#costCenterSelect").val();
                    let costCenterText = "Tất cả trạm";

                    if (
                      selectedCostCenters &&
                      selectedCostCenters.length > 0 &&
                      !selectedCostCenters.includes("all")
                    ) {
                      costCenterText = selectedCostCenters.join(", ");
                    }

                    const titleRow = $("<row></row>").append(
                      $(
                        '<c r="A1" t="inlineStr" s="20"><is><t>Báo cáo doanh thu năm ' +
                          year +
                          " (Pivot)</t></is></c>"
                      )
                    );
                    const filterRow = $("<row></row>").append(
                      $(
                        '<c r="A2" t="inlineStr" s="20"><is><t>Trạm: ' +
                          costCenterText +
                          "</t></is></c>"
                      )
                    );

                    $("sheetData", sheet).prepend(filterRow);
                    $("sheetData", sheet).prepend(titleRow);
                  },
                  exportOptions: {
                    format: {
                      body: function (data, row, column, node) {
                        return data.replace(/\./g, "").replace(/,/g, "");
                      },
                    },
                  },
                },
              ],
              language: {
                decimal: "",
                emptyTable: "Không có dữ liệu trong bảng",
                processing: "Đang xử lý...",
                zeroRecords: "Không tìm thấy kết quả phù hợp",
              },
            });

            // Add the buttons to the DOM
            currentTable.buttons().container().appendTo($(".card-body .mb-3"));

            // Force column adjustment after initialization
            setTimeout(() => {
              if (currentTable) {
                currentTable.columns.adjust();
              }
            }, 100);
          }, 50);

          return Object.values(pivotData);
        }

        // Function to update budget summary
        function updateBudgetSummary(data, year) {
          const budgetContainer = $("#budgetSummaryContainer");
          const budgetDetails = $("#budgetDetails");

          if (year != 2025) {
            budgetContainer.hide();
            return;
          }

          let totalNetRevenue = 0;
          let totalSales = 0;
          let totalPurchases = 0;
          let totalTransport = 0;
          let totalCommissionPurchase = 0;
          let totalCommissionSale = 0;
          let totalSalary = 0;
          let totalPayments = 0;

          // Calculate totals
          data.forEach((item) => {
            totalSales += item.totalSale;
            totalPurchases += item.totalPurchase;
            totalTransport += item.totalTransport;
            totalCommissionPurchase += item.totalCommissionPurchase;
            totalCommissionSale += item.totalCommissionSale;
            totalSalary += item.totalSalary;
            totalPayments += item.totalPayments;
            totalNetRevenue += item.netRevenue;
          });

          const currentBudget = STARTING_BUDGET_2025 + totalNetRevenue;

          // Format numbers
          const format = (num) => num.toLocaleString("vi-VN");

          // Build HTML
          const html = `
            <div class="budget-item">
              <span>Ngân sách ban đầu:</span>
              <span>${format(STARTING_BUDGET_2025)} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng doanh thu bán hàng:</span>
              <span class="positive">${format(totalSales)} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng chi phí mua hàng:</span>
              <span class="negative">-${format(totalPurchases)} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng chi phí vận chuyển:</span>
              <span class="negative">-${format(totalTransport)} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng hoa hồng mua hàng:</span>
              <span class="negative">-${format(
                totalCommissionPurchase
              )} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng hoa hồng bán hàng:</span>
              <span class="negative">-${format(totalCommissionSale)} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng chi phí lương:</span>
              <span class="negative">-${format(totalSalary)} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng thanh toán khác:</span>
              <span class="negative">-${format(totalPayments)} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng doanh thu ròng (2025):</span>
              <span class="${totalNetRevenue >= 0 ? "positive" : "negative"}">
                ${totalNetRevenue >= 0 ? "+" : ""}${format(totalNetRevenue)} VNĐ
              </span>
            </div>
            <div class="budget-item budget-total">
              <span>Ngân sách hiện tại:</span>
              <span class="${
                currentBudget >= STARTING_BUDGET_2025 ? "positive" : "negative"
              }">
                ${format(currentBudget)} VNĐ
              </span>
            </div>
          `;

          budgetDetails.html(html);
          budgetContainer.show();
        }

        $("#filterForm").on("submit", function (e) {
          e.preventDefault();
          const year = $("#yearSelect").val();
          const selectedCostCenters = $("#costCenterSelect").val();

          // Build the query parameters for multiple cost centers
          let queryParams = `year=${year}`;
          if (
            selectedCostCenters &&
            selectedCostCenters.length > 0 &&
            !selectedCostCenters.includes("all")
          ) {
            queryParams += `&costCenters=${selectedCostCenters.join(",")}`;
          }

          $.ajax({
            url: `/financeSummaryRevenueByCostCenter?${queryParams}`,
            method: "GET",
            success: function (data) {
              if (data.length === 0) {
                alert("Không tìm thấy dữ liệu cho năm đã chọn");
                $("#tableBody").html(
                  '<tr><td colspan="100%" class="text-center text-muted">Không có dữ liệu</td></tr>'
                );
                $("#budgetSummaryContainer").hide();
                return;
              }

              const pivotData = createPivotTable(data);
              updateSelectedCentersInfo();
              updateBudgetSummary(pivotData, year);
            },
            error: function (xhr, status, error) {
              alert("Lỗi khi tải dữ liệu: " + error);
            },
          });
        });

        // Group Management Functions (keeping the same logic)
        function loadCostCenterGroups() {
          $("#groupList").html(
            '<div class="list-group-item text-muted text-center">Đang tải nhóm...</div>'
          );

          $.ajax({
            url: "/financeSummaryCostCenterGroups",
            method: "GET",
            success: function (groups) {
              const groupList = $("#groupList");
              groupList.empty();

              if (groups.length === 0) {
                groupList.html(
                  '<div class="list-group-item text-muted text-center">Bạn chưa có nhóm nào</div>'
                );
                return;
              }

              groups.forEach((group) => {
                const groupItem = $(`
                  <div class="list-group-item group-item d-flex justify-content-between align-items-center">
                    <div>
                      <strong>${group.name}</strong>
                      <div class="text-muted small">${group.costCenters.length} trạm</div>
                    </div>
                    <div>
                      <button class="btn btn-sm btn-outline-danger delete-group" data-id="${group._id}">
                        Xóa
                      </button>
                    </div>
                  </div>
                `);

                groupItem.on("click", ".delete-group", function (e) {
                  e.stopPropagation();
                  const groupId = $(this).data("id");
                  deleteCostCenterGroup(groupId);
                });

                groupItem.on("click", function () {
                  applyGroupFilter(group.costCenters);
                });

                groupList.append(groupItem);
              });
            },
            error: function () {
              $("#groupList").html(
                '<div class="list-group-item text-danger text-center">Lỗi khi tải nhóm</div>'
              );
            },
          });
        }

        function applyGroupFilter(costCenters) {
          $("#costCenterSelect").val(costCenters).trigger("change");
          $("#groupModal").modal("hide");
          $("#filterForm").trigger("submit");
        }

        function deleteCostCenterGroup(groupId) {
          if (!confirm("Bạn có chắc chắn muốn xóa nhóm này không?")) return;

          $.ajax({
            url: `/financeSummaryCostCenterGroups/${groupId}`,
            method: "DELETE",
            success: function () {
              loadCostCenterGroups();
            },
            error: function () {
              alert("Lỗi khi xóa nhóm");
            },
          });
        }

        function saveCostCenterGroup() {
          const name = $("#groupName").val().trim();
          const costCenters = $("#groupCostCenters").val();

          if (!name) {
            alert("Vui lòng nhập tên nhóm");
            return;
          }

          if (!costCenters || costCenters.length === 0) {
            alert("Vui lòng chọn ít nhất một trạm");
            return;
          }

          $.ajax({
            url: "/financeSummaryCostCenterGroups",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
              name,
              costCenters,
            }),
            success: function () {
              $("#groupName").val("");
              $("#groupCostCenters").val(null).trigger("change");
              loadCostCenterGroups();
            },
            error: function () {
              alert("Lỗi khi lưu nhóm");
            },
          });
        }

        // Initialize the group management modal
        function initGroupModal() {
          // Initialize Select2 for group cost centers
          $("#groupCostCenters").select2({
            theme: "bootstrap-5",
            placeholder: "Chọn trạm...",
            allowClear: true,
            closeOnSelect: false,
            width: "100%",
          });

          // Populate group cost centers dropdown
          $.ajax({
            url: "/financeSummaryCostCenters",
            method: "GET",
            success: function (data) {
              const groupCostCenterSelect = $("#groupCostCenters");
              groupCostCenterSelect.empty();
              data.forEach((costCenter) => {
                groupCostCenterSelect.append(
                  `<option value="${costCenter.name}">${costCenter.name}</option>`
                );
              });
            },
          });

          // Save group button handler
          $("#saveGroup").on("click", saveCostCenterGroup);

          // Load existing groups when modal is shown
          $("#groupModal").on("shown.bs.modal", loadCostCenterGroups);
        }

        // Initialize group management
        initGroupModal();

        // Initial load
        $("#filterForm").trigger("submit");
      });
    </script>
  </body>
</html>
