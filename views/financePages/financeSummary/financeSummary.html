<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bảng Doanh Thu</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
      rel="stylesheet"
    />
    <style>
      .positive {
        color: green;
      }
      .negative {
        color: red;
      }
      .na-value {
        color: #6c757d;
        font-style: italic;
      }
      .details-row {
        background-color: #f8f9fa;
      }
      .select2-container--bootstrap-5 .select2-selection {
        min-height: 38px;
      }
      .dt-buttons .btn {
        margin-right: 5px;
      }
      .dataTables_wrapper .dt-buttons {
        float: right;
        margin-bottom: 15px;
      }
      .dataTables_info {
        padding-top: 0.85em !important;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h1 class="mb-4">Bảng Doanh Thu</h1>

      <div class="card mb-4">
        <div class="card-body">
          <form id="filterForm">
            <div class="row">
              <div class="col-md-4">
                <label for="yearSelect" class="form-label">Năm</label>
                <select class="form-select" id="yearSelect"></select>
              </div>
              <div class="col-md-6">
                <label for="costCenterSelect" class="form-label">Trạm</label>
                <select
                  class="form-select"
                  id="costCenterSelect"
                  multiple="multiple"
                >
                  <option value="all">Tất Cả Trạm</option>
                </select>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <div class="d-grid w-100">
                  <button type="submit" class="btn btn-primary">Áp dụng</button>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm mt-2"
                    id="clearSelection"
                  >
                    Xóa chọn
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="mb-3">
            <small class="text-muted" id="selectedCentersInfo"></small>
          </div>
          <table
            id="revenueTable"
            class="table table-striped"
            style="width: 100%"
          >
            <thead>
              <tr>
                <th>Trạm</th>
                <th>Tháng</th>
                <th>Tổng Bán Hàng</th>
                <th>Tổng Mua Hàng</th>
                <th>Chi Phí Vận Chuyển</th>
                <th>Hoa Hồng Mua Hàng</th>
                <th>Hoa Hồng Bán Hàng</th>
                <th>Tổng Lương</th>
                <th>Tổng Thanh Toán</th>
                <th>Doanh Thu Ròng</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="/components/header/headerLoader.js?v=1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
    <script>
      $(document).ready(function () {
        // Month mapping for proper sorting
        const monthOrder = {
          "Tháng Một": 1,
          "Tháng Hai": 2,
          "Tháng Ba": 3,
          "Tháng Tư": 4,
          "Tháng Năm": 5,
          "Tháng Sáu": 6,
          "Tháng Bảy": 7,
          "Tháng Tám": 8,
          "Tháng Chín": 9,
          "Tháng Mười": 10,
          "Tháng Mười Một": 11,
          "Tháng Mười Hai": 12,
        };

        // Custom sorting function for Vietnamese months
        jQuery.extend(jQuery.fn.dataTableExt.oSort, {
          "vietnamese-month-pre": function (a) {
            // Extract month and year from "Tháng Ba 2025" format
            const parts = a.split(" ");
            if (parts.length >= 3) {
              const month = parts[0] + " " + parts[1]; // "Tháng Ba"
              const year = parseInt(parts[2]); // 2025
              const monthNum = monthOrder[month] || 0;
              return year * 100 + monthNum; // 202503 for "Tháng Ba 2025"
            }
            return 0;
          },
          "vietnamese-month-asc": function (a, b) {
            return a - b;
          },
          "vietnamese-month-desc": function (a, b) {
            return b - a;
          },
        });

        const table = $("#revenueTable").DataTable({
          responsive: true,
          order: [
            [0, "asc"],
            [1, "asc"],
          ],
          dom: '<"top"lBf>rt<"bottom"ip>',
          buttons: [
            {
              extend: "excelHtml5",
              text: "Xuất Excel",
              className: "btn btn-success",
              title: "Báo cáo doanh thu",
              filename: function () {
                const year = $("#yearSelect").val();
                const selectedCostCenters = $("#costCenterSelect").val();
                let fileName = `Bao_cao_doanh_thu_${year}`;

                if (
                  selectedCostCenters &&
                  selectedCostCenters.length > 0 &&
                  !selectedCostCenters.includes("all")
                ) {
                  fileName += `_${selectedCostCenters.join("_")}`;
                }

                return fileName;
              },
              customize: function (xlsx) {
                const sheet = xlsx.xl.worksheets["sheet1.xml"];

                // Format currency cells
                $('row c[r^="C"]', sheet).attr("s", "2"); // Column C (totalSale)
                $('row c[r^="D"]', sheet).attr("s", "2"); // Column D (totalPurchase)
                $('row c[r^="E"]', sheet).attr("s", "2"); // Column E (totalTransport)
                $('row c[r^="F"]', sheet).attr("s", "2"); // Column F (totalCommissionPurchase)
                $('row c[r^="G"]', sheet).attr("s", "2"); // Column G (totalCommissionSale)
                $('row c[r^="H"]', sheet).attr("s", "2"); // Column H (totalSalary)
                $('row c[r^="I"]', sheet).attr("s", "2"); // Column I (totalPayments)
                $('row c[r^="J"]', sheet).attr("s", "2"); // Column J (netRevenue)

                // Add header information
                const year = $("#yearSelect").val();
                const selectedCostCenters = $("#costCenterSelect").val();
                let costCenterText = "Tất cả trạm";

                if (
                  selectedCostCenters &&
                  selectedCostCenters.length > 0 &&
                  !selectedCostCenters.includes("all")
                ) {
                  costCenterText = selectedCostCenters.join(", ");
                }

                // Add two header rows
                $("row:first c", sheet).attr("s", "20"); // Style for header
                $("row:eq(1) c", sheet).attr("s", "20"); // Style for subheader

                // Add title and filter information
                const titleRow = $("<row></row>").append(
                  $(
                    '<c r="A1" t="inlineStr" s="20"><is><t>Báo cáo doanh thu năm ' +
                      year +
                      "</t></is></c>"
                  )
                );
                const filterRow = $("<row></row>").append(
                  $(
                    '<c r="A2" t="inlineStr" s="20"><is><t>Trạm: ' +
                      costCenterText +
                      "</t></is></c>"
                  )
                );

                $("sheetData", sheet).prepend(filterRow);
                $("sheetData", sheet).prepend(titleRow);

                // Merge title cells
                const mergeCells = $('<mergeCells count="2"></mergeCells>');
                mergeCells.append('<mergeCell ref="A1:J1"/>');
                mergeCells.append('<mergeCell ref="A2:J2"/>');

                if ($("mergeCells", sheet).length === 0) {
                  $("worksheet", sheet).append(mergeCells);
                } else {
                  $("mergeCells", sheet).append('<mergeCell ref="A1:J1"/>');
                  $("mergeCells", sheet).append('<mergeCell ref="A2:J2"/>');
                  $("mergeCells", sheet).attr(
                    "count",
                    $("mergeCell", sheet).length
                  );
                }
              },
              exportOptions: {
                format: {
                  body: function (data, row, column, node) {
                    // Remove the VNĐ suffix and HTML tags from the data
                    return data.replace(/ VNĐ$/, "").replace(/<[^>]*>/g, "");
                  },
                },
              },
            },
          ],
          language: {
            decimal: "",
            emptyTable: "Không có dữ liệu trong bảng",
            info: "Hiển thị _START_ đến _END_ của _TOTAL_ mục",
            infoEmpty: "Hiển thị 0 đến 0 của 0 mục",
            infoFiltered: "(lọc từ _MAX_ tổng số mục)",
            infoPostFix: "",
            thousands: ",",
            lengthMenu: "Hiển thị _MENU_ mục",
            loadingRecords: "Đang tải...",
            processing: "Đang xử lý...",
            search: "Tìm kiếm:",
            zeroRecords: "Không tìm thấy kết quả phù hợp",
            paginate: {
              first: "Đầu tiên",
              last: "Cuối cùng",
              next: "Tiếp theo",
              previous: "Trước",
            },
            aria: {
              sortAscending: ": sắp xếp tăng dần",
              sortDescending: ": sắp xếp giảm dần",
            },
          },
          columns: [
            {
              data: "costCenter",
              render: function (data) {
                return data === "N/A"
                  ? '<span class="na-value">N/A</span>'
                  : data;
              },
            },
            {
              data: null,
              type: "vietnamese-month",
              render: function (data) {
                return `${data.actualMonth} ${data.actualYear}`;
              },
            },
            {
              data: "totalSale",
              render: function (data) {
                return `<span class="${
                  data >= 0 ? "positive" : "negative"
                }">${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
            {
              data: "totalPurchase",
              render: function (data) {
                return `<span>${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
            {
              data: "totalTransport",
              render: function (data) {
                return `<span>${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
            {
              data: "totalCommissionPurchase",
              render: function (data) {
                return `<span>${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
            {
              data: "totalCommissionSale",
              render: function (data) {
                return `<span>${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
            {
              data: "totalSalary",
              render: function (data) {
                return `<span>${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
            {
              data: "totalPayments",
              render: function (data) {
                return `<span class="${
                  data > 0 ? "negative" : ""
                }">${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
            {
              data: "netRevenue",
              render: function (data) {
                return `<span class="${
                  data >= 0 ? "positive" : "negative"
                }">${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
          ],
        });

        // Add the buttons to the DOM
        table
          .buttons()
          .container()
          .appendTo($(".dataTables_wrapper .col-md-6:eq(0)"));

        // Initialize Select2 for cost center selection
        $("#costCenterSelect").select2({
          theme: "bootstrap-5",
          placeholder: "Chọn trạm...",
          allowClear: true,
          closeOnSelect: false,
          width: "100%",
        });

        // Populate year dropdown
        const currentYear = new Date().getFullYear();
        const yearSelect = $("#yearSelect");

        for (let year = currentYear; year >= currentYear - 5; year--) {
          yearSelect.append(`<option value="${year}">${year}</option>`);
        }

        yearSelect.val(currentYear);

        // Fetch cost centers and populate dropdown
        $.ajax({
          url: "/financeSummaryCostCenters",
          method: "GET",
          success: function (data) {
            const costCenterSelect = $("#costCenterSelect");
            data.forEach((costCenter) => {
              costCenterSelect.append(
                `<option value="${costCenter.name}">${costCenter.name}</option>`
              );
            });

            // Set default to "all" and trigger Select2 update
            costCenterSelect.val(["all"]).trigger("change");
          },
          error: function () {
            console.error("Không thể tải danh sách trạm");
            alert("Lỗi khi tải danh sách trạm");
          },
        });

        // Handle "Tất Cả Trạm" selection logic
        $("#costCenterSelect").on("change", function () {
          const selectedValues = $(this).val();

          if (selectedValues && selectedValues.includes("all")) {
            // If "all" is selected, clear other selections
            if (selectedValues.length > 1) {
              $(this).val(["all"]).trigger("change");
            }
          }
        });

        // Clear selection button
        $("#clearSelection").on("click", function () {
          $("#costCenterSelect").val(["all"]).trigger("change");
        });

        // Update selected centers info
        function updateSelectedCentersInfo() {
          const selectedValues = $("#costCenterSelect").val();
          const infoElement = $("#selectedCentersInfo");

          if (
            !selectedValues ||
            selectedValues.length === 0 ||
            selectedValues.includes("all")
          ) {
            infoElement.text("Hiển thị: Tất cả trạm");
          } else {
            infoElement.text(
              `Hiển thị: ${
                selectedValues.length
              } trạm được chọn (${selectedValues.join(", ")})`
            );
          }
        }

        $("#costCenterSelect").on("change", updateSelectedCentersInfo);

        $("#filterForm").on("submit", function (e) {
          e.preventDefault();
          const year = $("#yearSelect").val();
          const selectedCostCenters = $("#costCenterSelect").val();

          // Build the query parameters for multiple cost centers
          let queryParams = `year=${year}`;
          if (
            selectedCostCenters &&
            selectedCostCenters.length > 0 &&
            !selectedCostCenters.includes("all")
          ) {
            // Send selected cost centers as comma-separated string
            queryParams += `&costCenters=${selectedCostCenters.join(",")}`;
          }

          $.ajax({
            url: `/financeSummaryRevenueByCostCenter?${queryParams}`,
            method: "GET",
            success: function (data) {
              if (data.length === 0) {
                alert("Không tìm thấy dữ liệu cho năm đã chọn");
                table.clear().draw();
                return;
              }

              // Group by cost center and month for summary view
              const summaryData = data.reduce((acc, item) => {
                const key = `${item.costCenter}-${item.actualMonth}-${item.actualYear}`;
                if (!acc[key]) {
                  acc[key] = {
                    costCenter: item.costCenter,
                    actualMonth: item.actualMonth,
                    actualYear: item.actualYear,
                    totalSale: 0,
                    totalPurchase: 0,
                    totalTransport: 0,
                    totalCommissionPurchase: 0,
                    totalCommissionSale: 0,
                    totalSalary: 0,
                    totalPayments: 0,
                    netRevenue: 0,
                  };
                }

                acc[key].totalSale += item.totalSale;
                acc[key].totalPurchase += item.totalPurchase;
                acc[key].totalTransport += item.totalTransport;
                acc[key].totalCommissionPurchase +=
                  item.totalCommissionPurchase;
                acc[key].totalCommissionSale += item.totalCommissionSale;
                acc[key].totalSalary += item.grossSalary;
                acc[key].totalPayments += item.totalPayments;
                acc[key].netRevenue =
                  acc[key].totalSale -
                  acc[key].totalPurchase -
                  acc[key].totalTransport -
                  acc[key].totalCommissionPurchase -
                  acc[key].totalCommissionSale -
                  acc[key].totalSalary -
                  acc[key].totalPayments;

                return acc;
              }, {});

              table.clear().rows.add(Object.values(summaryData)).draw();
              updateSelectedCentersInfo();
            },
            error: function (xhr, status, error) {
              alert("Lỗi khi tải dữ liệu: " + error);
            },
          });
        });

        // Initial load
        $("#filterForm").trigger("submit");
      });
    </script>
  </body>
</html>
