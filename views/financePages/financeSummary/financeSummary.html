<!-- views/financePages/financeSummary/financeSummary.html -->
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bảng Doanh Thu</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <style>
      .positive {
        color: green;
      }
      .negative {
        color: red;
      }
      .na-value {
        color: #6c757d;
        font-style: italic;
      }
      .details-row {
        background-color: #f8f9fa;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h1 class="mb-4">Bảng Doanh Thu</h1>

      <div class="card mb-4">
        <div class="card-body">
          <form id="filterForm">
            <div class="row">
              <div class="col-md-4">
                <label for="yearSelect" class="form-label">Năm</label>
                <select class="form-select" id="yearSelect"></select>
              </div>
              <div class="col-md-4">
                <label for="costCenterSelect" class="form-label">Trạm</label>
                <select class="form-select" id="costCenterSelect">
                  <option value="all">Tất Cả Trạm</option>
                </select>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">Áp dụng</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <table
            id="revenueTable"
            class="table table-striped"
            style="width: 100%"
          >
            <thead>
              <tr>
                <th>Trạm</th>
                <th>Tháng</th>
                <th>Tổng Bán Hàng</th>
                <th>Tổng Mua Hàng</th>
                <th>Chi Phí Vận Chuyển</th>
                <th>Hoa Hồng Mua Hàng</th>
                <th>Hoa Hồng Bán Hàng</th>
                <th>Tổng Lương</th>
                <th>Tổng Thanh Toán</th>
                <th>Doanh Thu Ròng</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="/components/header/headerLoader.js?v=1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script>
      $(document).ready(function () {
        // Month mapping for proper sorting
        const monthOrder = {
          "Tháng Một": 1,
          "Tháng Hai": 2,
          "Tháng Ba": 3,
          "Tháng Tư": 4,
          "Tháng Năm": 5,
          "Tháng Sáu": 6,
          "Tháng Bảy": 7,
          "Tháng Tám": 8,
          "Tháng Chín": 9,
          "Tháng Mười": 10,
          "Tháng Mười Một": 11,
          "Tháng Mười Hai": 12,
        };

        // Custom sorting function for Vietnamese months
        jQuery.extend(jQuery.fn.dataTableExt.oSort, {
          "vietnamese-month-pre": function (a) {
            // Extract month and year from "Tháng Ba 2025" format
            const parts = a.split(" ");
            if (parts.length >= 3) {
              const month = parts[0] + " " + parts[1]; // "Tháng Ba"
              const year = parseInt(parts[2]); // 2025
              const monthNum = monthOrder[month] || 0;
              return year * 100 + monthNum; // 202503 for "Tháng Ba 2025"
            }
            return 0;
          },
          "vietnamese-month-asc": function (a, b) {
            return a - b;
          },
          "vietnamese-month-desc": function (a, b) {
            return b - a;
          },
        });

        const table = $("#revenueTable").DataTable({
          responsive: true,
          order: [
            [0, "asc"],
            [1, "asc"],
          ],
          language: {
            decimal: "",
            emptyTable: "Không có dữ liệu trong bảng",
            info: "Hiển thị _START_ đến _END_ của _TOTAL_ mục",
            infoEmpty: "Hiển thị 0 đến 0 của 0 mục",
            infoFiltered: "(lọc từ _MAX_ tổng số mục)",
            infoPostFix: "",
            thousands: ",",
            lengthMenu: "Hiển thị _MENU_ mục",
            loadingRecords: "Đang tải...",
            processing: "Đang xử lý...",
            search: "Tìm kiếm:",
            zeroRecords: "Không tìm thấy kết quả phù hợp",
            paginate: {
              first: "Đầu tiên",
              last: "Cuối cùng",
              next: "Tiếp theo",
              previous: "Trước",
            },
            aria: {
              sortAscending: ": sắp xếp tăng dần",
              sortDescending: ": sắp xếp giảm dần",
            },
          },
          columns: [
            {
              data: "costCenter",
              render: function (data) {
                return data === "N/A"
                  ? '<span class="na-value">N/A</span>'
                  : data;
              },
            },
            {
              data: null,
              type: "vietnamese-month",
              render: function (data) {
                return `${data.actualMonth} ${data.actualYear}`;
              },
            },
            {
              data: "totalSale",
              render: function (data) {
                return `<span class="${
                  data >= 0 ? "positive" : "negative"
                }">${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
            {
              data: "totalPurchase",
              render: function (data) {
                return `<span>${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
            {
              data: "totalTransport",
              render: function (data) {
                return `<span>${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
            {
              data: "totalCommissionPurchase",
              render: function (data) {
                return `<span>${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
            {
              data: "totalCommissionSale",
              render: function (data) {
                return `<span>${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
            {
              data: "totalSalary",
              render: function (data) {
                return `<span>${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
            {
              data: "totalPayments",
              render: function (data) {
                return `<span class="${
                  data > 0 ? "negative" : ""
                }">${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
            {
              data: "netRevenue",
              render: function (data) {
                return `<span class="${
                  data >= 0 ? "positive" : "negative"
                }">${data.toLocaleString("vi-VN")} VNĐ</span>`;
              },
            },
          ],
        });

        // Populate year dropdown
        const currentYear = new Date().getFullYear();
        const yearSelect = $("#yearSelect");

        for (let year = currentYear; year >= currentYear - 5; year--) {
          yearSelect.append(`<option value="${year}">${year}</option>`);
        }

        yearSelect.val(currentYear);

        // Fetch cost centers and populate dropdown
        $.ajax({
          url: "/financeSummaryCostCenters",
          method: "GET",
          success: function (data) {
            const costCenterSelect = $("#costCenterSelect");
            data.forEach((costCenter) => {
              costCenterSelect.append(
                `<option value="${costCenter.name}">${costCenter.name}</option>`
              );
            });
          },
          error: function () {
            console.error("Không thể tải danh sách trạm");
            alert("Lỗi khi tải danh sách trạm");
          },
        });

        $("#filterForm").on("submit", function (e) {
          e.preventDefault();
          const year = $("#yearSelect").val();
          const costCenter = $("#costCenterSelect").val();

          $.ajax({
            url: `/financeSummaryRevenueByCostCenter?year=${year}`,
            method: "GET",
            success: function (data) {
              if (data.length === 0) {
                alert("Không tìm thấy dữ liệu cho năm đã chọn");
                table.clear().draw();
                return;
              }

              // Filter by cost center if not "all"
              if (costCenter !== "all") {
                data = data.filter((item) => item.costCenter === costCenter);
              }

              // Group by cost center and month for summary view
              const summaryData = data.reduce((acc, item) => {
                const key = `${item.costCenter}-${item.actualMonth}-${item.actualYear}`;
                if (!acc[key]) {
                  acc[key] = {
                    costCenter: item.costCenter,
                    actualMonth: item.actualMonth,
                    actualYear: item.actualYear,
                    totalSale: 0,
                    totalPurchase: 0,
                    totalTransport: 0,
                    totalCommissionPurchase: 0,
                    totalCommissionSale: 0,
                    totalSalary: 0,
                    totalPayments: 0,
                    netRevenue: 0,
                  };
                }

                acc[key].totalSale += item.totalSale;
                acc[key].totalPurchase += item.totalPurchase;
                acc[key].totalTransport += item.totalTransport;
                acc[key].totalCommissionPurchase +=
                  item.totalCommissionPurchase;
                acc[key].totalCommissionSale += item.totalCommissionSale;
                acc[key].totalSalary += item.grossSalary;
                acc[key].totalPayments += item.totalPayments;
                acc[key].netRevenue =
                  acc[key].totalSale -
                  acc[key].totalPurchase -
                  acc[key].totalTransport -
                  acc[key].totalCommissionPurchase -
                  acc[key].totalCommissionSale -
                  acc[key].totalSalary -
                  acc[key].totalPayments;

                return acc;
              }, {});

              table.clear().rows.add(Object.values(summaryData)).draw();
            },
            error: function (xhr, status, error) {
              alert("Lỗi khi tải dữ liệu: " + error);
            },
          });
        });

        $("#filterForm").trigger("submit");
      });
    </script>
  </body>
</html>
