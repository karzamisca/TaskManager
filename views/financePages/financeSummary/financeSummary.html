<!--views/financePages/financeSummary/financeSummary.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Revenue by Cost Center</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <style>
      .positive {
        color: green;
      }
      .negative {
        color: red;
      }
      .na-value {
        color: #6c757d;
        font-style: italic;
      }
      .details-row {
        background-color: #f8f9fa;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h1 class="mb-4">Cost Center Net Revenue Analysis</h1>

      <div class="card mb-4">
        <div class="card-body">
          <form id="filterForm">
            <div class="row">
              <div class="col-md-4">
                <label for="yearSelect" class="form-label">Year</label>
                <select class="form-select" id="yearSelect"></select>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">
                  Generate Report
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <table
            id="revenueTable"
            class="table table-striped"
            style="width: 100%"
          >
            <thead>
              <tr>
                <th>Cost Center</th>
                <th>Actual Month</th>
                <th>Total Sales</th>
                <th>Total Purchases</th>
                <th>Transport Cost</th>
                <th>Purchase Commission</th>
                <th>Sales Commission</th>
                <th>Total Salaries</th>
                <th>Net Revenue</th>
                <th>Salary/Sales Ratio</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script>
      $(document).ready(function () {
        const table = $("#revenueTable").DataTable({
          responsive: true,
          order: [
            [0, "asc"],
            [1, "asc"],
          ],
          columns: [
            {
              data: "costCenter",
              render: function (data) {
                return data === "N/A"
                  ? '<span class="na-value">N/A</span>'
                  : data;
              },
            },
            {
              data: null,
              render: function (data) {
                return `${data.actualMonth} ${data.actualYear}`;
              },
            },
            {
              data: "totalSale",
              render: function (data) {
                return `<span class="${
                  data >= 0 ? "positive" : "negative"
                }">${data.toLocaleString()} VND</span>`;
              },
            },
            {
              data: "totalPurchase",
              render: function (data) {
                return `<span>${data.toLocaleString()} VND</span>`;
              },
            },
            {
              data: "totalTransport",
              render: function (data) {
                return `<span>${data.toLocaleString()} VND</span>`;
              },
            },
            {
              data: "totalCommissionPurchase",
              render: function (data) {
                return `<span>${data.toLocaleString()} VND</span>`;
              },
            },
            {
              data: "totalCommissionSale",
              render: function (data) {
                return `<span>${data.toLocaleString()} VND</span>`;
              },
            },
            {
              data: "totalSalary",
              render: function (data) {
                return `<span>${data.toLocaleString()} VND</span>`;
              },
            },
            {
              data: "netRevenue",
              render: function (data) {
                return `<span class="${
                  data >= 0 ? "positive" : "negative"
                }">${data.toLocaleString()} VND</span>`;
              },
            },
            {
              data: "ratio",
              render: function (data) {
                const ratio = (data * 100).toFixed(2) + "%";
                return `<span>${ratio}</span>`;
              },
            },
          ],
        });

        // Populate year dropdown
        const currentYear = new Date().getFullYear();
        const yearSelect = $("#yearSelect");

        for (let year = currentYear; year >= currentYear - 5; year--) {
          yearSelect.append(`<option value="${year}">${year}</option>`);
        }

        yearSelect.val(currentYear);

        $("#filterForm").on("submit", function (e) {
          e.preventDefault();
          const year = $("#yearSelect").val();

          $.ajax({
            url: `/api/revenue-by-cost-center?year=${year}`,
            method: "GET",
            success: function (data) {
              if (data.length === 0) {
                alert("No data found for the selected year");
              }

              // Group by cost center and month for summary view
              const summaryData = data.reduce((acc, item) => {
                const key = `${item.costCenter}-${item.actualMonth}-${item.actualYear}`;
                if (!acc[key]) {
                  acc[key] = {
                    costCenter: item.costCenter,
                    actualMonth: item.actualMonth,
                    actualYear: item.actualYear,
                    totalSale: 0,
                    totalPurchase: 0,
                    totalTransport: 0,
                    totalCommissionPurchase: 0,
                    totalCommissionSale: 0,
                    totalSalary: 0,
                    netRevenue: 0,
                  };
                }

                acc[key].totalSale += item.totalSale;
                acc[key].totalPurchase += item.totalPurchase;
                acc[key].totalTransport += item.totalTransport;
                acc[key].totalCommissionPurchase +=
                  item.totalCommissionPurchase;
                acc[key].totalCommissionSale += item.totalCommissionSale;
                acc[key].totalSalary += item.grossSalary;
                acc[key].netRevenue =
                  acc[key].totalSale -
                  acc[key].totalPurchase -
                  acc[key].totalTransport -
                  acc[key].totalCommissionPurchase -
                  acc[key].totalCommissionSale -
                  acc[key].totalSalary;

                return acc;
              }, {});

              table.clear().rows.add(Object.values(summaryData)).draw();
            },
            error: function (xhr, status, error) {
              alert("Error fetching data: " + error);
            },
          });
        });

        $("#filterForm").trigger("submit");
      });
    </script>
  </body>
</html>
