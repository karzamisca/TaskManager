<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bảng Doanh Thu</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
      rel="stylesheet"
    />
    <style>
      .positive {
        color: green;
      }
      .negative {
        color: red;
      }
      .na-value {
        color: #6c757d;
        font-style: italic;
      }
      .select2-container--bootstrap-5 .select2-selection {
        min-height: 38px;
      }
      .dt-buttons .btn {
        margin-right: 5px;
      }
      .dataTables_wrapper .dt-buttons {
        float: right;
        margin-bottom: 15px;
      }
      .dataTables_info {
        padding-top: 0.85em !important;
      }
      .budget-summary {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
      }
      .budget-summary h5 {
        margin-bottom: 15px;
      }
      .budget-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .budget-total {
        font-weight: bold;
        border-top: 1px solid #dee2e6;
        padding-top: 10px;
        margin-top: 10px;
      }
      .group-item:hover {
        background-color: #f8f9fa;
        cursor: pointer;
      }
      .metric-row {
        font-weight: bold;
      }
      .metric-row td:first-child {
        background-color: #f8f9fa;
        border-right: 2px solid #dee2e6;
      }
      .center-header {
        background-color: #e9ecef;
        font-weight: bold;
        text-align: center;
      }
      .month-subheader {
        background-color: #f8f9fa;
        font-size: 0.9em;
        text-align: center;
      }
      .pivot-table {
        font-size: 0.9em;
      }
      .pivot-table th {
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .pivot-table td:first-child {
        position: sticky;
        left: 0;
        z-index: 5;
        background-color: #f8f9fa;
      }
      .table-container {
        max-height: 600px;
        overflow: auto;
      }

      /* Chart Styles */
      .chart-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
        height: 400px; /* Fixed height */
      }

      .chart-container canvas {
        max-width: 100% !important;
        max-height: 350px !important;
        width: 100% !important;
        height: auto !important;
      }

      .chart-container.small {
        height: 300px;
      }

      .chart-container.small canvas {
        max-height: 250px !important;
      }

      .chart-controls {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .chart-title {
        font-size: 1.1em;
        font-weight: bold;
        margin-bottom: 15px;
        color: #495057;
        height: 20px; /* Fixed height for title */
      }

      /* View Toggle Buttons */
      .view-toggle {
        margin-bottom: 20px;
      }

      .view-toggle .btn-group .btn {
        min-width: 120px;
      }

      /* Improved Group Modal Styles */
      #groupModal .modal-dialog {
        max-width: 900px;
      }

      .cost-center-selection {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        background-color: #f8f9fa;
        max-height: 400px;
        overflow-y: auto;
      }

      .cost-center-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 8px;
      }

      .cost-center-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
      }

      .cost-center-item:hover {
        background-color: #e3f2fd;
        border-color: #2196f3;
      }

      .cost-center-item.selected {
        background-color: #1976d2;
        border-color: #1976d2;
        color: white;
      }

      .cost-center-item input[type="checkbox"] {
        margin-right: 8px;
        cursor: pointer;
      }

      .selected-count {
        background-color: #1976d2;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        display: inline-block;
        margin-bottom: 10px;
      }

      .selection-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .selection-actions button {
        padding: 4px 12px;
        font-size: 0.85em;
      }

      .group-creation-section {
        border-left: 2px solid #dee2e6;
        padding-left: 20px;
      }

      @media (max-width: 768px) {
        .cost-center-grid {
          grid-template-columns: 1fr;
        }

        #groupModal .modal-dialog {
          max-width: 95%;
          margin: 10px auto;
        }

        .group-creation-section {
          border-left: none;
          border-top: 2px solid #dee2e6;
          padding-left: 0;
          padding-top: 20px;
          margin-top: 20px;
        }

        .chart-container canvas {
          max-height: 300px !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid mt-4">
      <h1 class="mb-4">Bảng Doanh Thu</h1>

      <div class="card mb-4">
        <div class="card-body">
          <form id="filterForm">
            <div class="row">
              <div class="col-md-4">
                <label for="yearSelect" class="form-label">Năm</label>
                <select class="form-select" id="yearSelect"></select>
              </div>
              <div class="col-md-6">
                <label for="costCenterSelect" class="form-label">Trạm</label>
                <select
                  class="form-select"
                  id="costCenterSelect"
                  multiple="multiple"
                >
                  <option value="all">Tất Cả Trạm</option>
                </select>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <div class="d-grid w-100">
                  <button type="submit" class="btn btn-primary">Áp dụng</button>
                  <div class="d-flex justify-content-between mt-2">
                    <button
                      type="button"
                      class="btn btn-outline-secondary btn-sm"
                      id="clearSelection"
                    >
                      Xóa chọn
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-primary btn-sm"
                      id="manageGroups"
                      data-bs-toggle="modal"
                      data-bs-target="#groupModal"
                    >
                      Nhóm trạm
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- View Toggle -->
      <div class="view-toggle d-flex justify-content-center">
        <div class="btn-group" role="group" aria-label="View toggle">
          <input
            type="radio"
            class="btn-check"
            name="viewOptions"
            id="tableView"
            autocomplete="off"
            checked
          />
          <label class="btn btn-outline-primary" for="tableView"
            >Bảng dữ liệu</label
          >

          <input
            type="radio"
            class="btn-check"
            name="viewOptions"
            id="chartView"
            autocomplete="off"
          />
          <label class="btn btn-outline-primary" for="chartView">Biểu đồ</label>
        </div>
      </div>

      <!-- Table View -->
      <div id="tableViewContainer">
        <div class="card">
          <div class="card-body">
            <div class="mb-3">
              <small class="text-muted" id="selectedCentersInfo"></small>
            </div>
            <div class="table-container">
              <table
                id="revenueTable"
                class="table table-striped table-bordered pivot-table"
                style="width: 100%"
              >
                <thead id="tableHead">
                  <!-- Dynamic header will be inserted here -->
                </thead>
                <tbody id="tableBody">
                  <!-- Dynamic body will be inserted here -->
                </tbody>
              </table>
            </div>

            <div
              id="budgetSummaryContainer"
              class="budget-summary mt-4"
              style="display: none"
            >
              <h5>Tổng hợp ngân sách 2025</h5>
              <div id="budgetDetails">
                <!-- Budget details will be inserted here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart View -->
      <div id="chartViewContainer" style="display: none">
        <!-- Chart Controls -->
        <div class="chart-controls">
          <div class="row">
            <div class="col-md-4">
              <label for="chartType" class="form-label">Loại biểu đồ</label>
              <select class="form-select" id="chartType">
                <option value="line">Đường</option>
                <option value="bar">Cột</option>
                <option value="area">Vùng</option>
                <option value="pie">Tròn</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="chartMetric" class="form-label">Chỉ số</label>
              <select class="form-select" id="chartMetric">
                <option value="netRevenue">Doanh Thu Ròng</option>
                <option value="totalSale">Tổng Bán Hàng</option>
                <option value="totalPurchase">Tổng Mua Hàng</option>
                <option value="totalTransport">Chi Phí Vận Chuyển</option>
                <option value="totalCommissionPurchase">
                  Hoa Hồng Mua Hàng
                </option>
                <option value="totalCommissionSale">Hoa Hồng Bán Hàng</option>
                <option value="totalSalary">Tổng Lương</option>
                <option value="totalPayments">Tổng Thanh Toán</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="chartGroupBy" class="form-label">Nhóm theo</label>
              <select class="form-select" id="chartGroupBy">
                <option value="month">Tháng</option>
                <option value="costCenter">Trạm</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Charts Container -->
        <div class="row">
          <div class="col-12">
            <div class="chart-container">
              <div class="chart-title" id="mainChartTitle">
                Doanh Thu Ròng theo Tháng
              </div>
              <canvas id="mainChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Improved Group Management Modal -->
    <div class="modal fade" id="groupModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Quản lý nhóm trạm</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <!-- Cost Center Selection Section -->
              <div class="col-lg-7">
                <h6 class="mb-3">Chọn trạm cho nhóm</h6>

                <!-- Selection Actions -->
                <div class="selection-actions">
                  <button
                    type="button"
                    class="btn btn-outline-primary btn-sm"
                    id="selectAll"
                  >
                    Chọn tất cả
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm"
                    id="clearAll"
                  >
                    Bỏ chọn tất cả
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-info btn-sm"
                    id="invertSelection"
                  >
                    Đảo ngược
                  </button>
                </div>

                <!-- Selected Count -->
                <div class="mb-2">
                  <span class="selected-count" id="selectedCount"
                    >0 trạm được chọn</span
                  >
                </div>

                <!-- Cost Center Grid -->
                <div class="cost-center-selection">
                  <div class="cost-center-grid" id="costCenterGrid">
                    <div class="text-center text-muted">
                      Đang tải danh sách trạm...
                    </div>
                  </div>
                </div>
              </div>

              <!-- Group Creation Section -->
              <div class="col-lg-5 group-creation-section">
                <div class="mb-4">
                  <h6 class="mb-3">Tạo nhóm mới</h6>
                  <div class="mb-3">
                    <label for="groupName" class="form-label">Tên nhóm</label>
                    <input
                      type="text"
                      class="form-control"
                      id="groupName"
                      placeholder="Nhập tên nhóm..."
                    />
                  </div>
                  <button
                    type="button"
                    class="btn btn-primary w-100"
                    id="saveGroup"
                  >
                    <i class="bi bi-plus-circle"></i> Tạo nhóm
                  </button>
                </div>

                <div>
                  <h6 class="mb-3">Nhóm đã tạo</h6>
                  <div
                    id="groupList"
                    class="list-group"
                    style="max-height: 300px; overflow-y: auto"
                  >
                    <div class="list-group-item text-muted text-center">
                      Đang tải nhóm...
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script>
      $(document).ready(function () {
        // Ensure Chart.js is loaded
        if (typeof Chart === "undefined") {
          console.error("Chart.js not loaded");
          alert(
            "Lỗi: Chart.js không tải được. Vui lòng kiểm tra kết nối internet."
          );
          return;
        }

        // Chart.js default configuration
        Chart.defaults.font.family = "'Segoe UI', 'Roboto', sans-serif";
        Chart.defaults.color = "#495057";

        // Constants
        const STARTING_BUDGET_2025 = 2866850896;

        // Chart variables
        let mainChart = null;
        let comparisonChart = null;
        let netRevenueChart = null;
        let trendChart = null;
        let currentChartData = [];

        // Month mapping for proper sorting
        const monthOrder = {
          "Tháng Một": 1,
          "Tháng Hai": 2,
          "Tháng Ba": 3,
          "Tháng Tư": 4,
          "Tháng Năm": 5,
          "Tháng Sáu": 6,
          "Tháng Bảy": 7,
          "Tháng Tám": 8,
          "Tháng Chín": 9,
          "Tháng Mười": 10,
          "Tháng Mười Một": 11,
          "Tháng Mười Hai": 12,
        };

        // Metrics configuration
        const metrics = [
          {
            key: "totalSale",
            label: "Tổng Bán Hàng",
            isPositive: true,
            color: "#28a745",
          },
          {
            key: "totalPurchase",
            label: "Tổng Mua Hàng",
            isPositive: false,
            color: "#dc3545",
          },
          {
            key: "totalTransport",
            label: "Chi Phí Vận Chuyển",
            isPositive: false,
            color: "#ffc107",
          },
          {
            key: "totalCommissionPurchase",
            label: "Hoa Hồng Mua Hàng",
            isPositive: false,
            color: "#fd7e14",
          },
          {
            key: "totalCommissionSale",
            label: "Hoa Hồng Bán Hàng",
            isPositive: false,
            color: "#e83e8c",
          },
          {
            key: "totalSalary",
            label: "Tổng Lương",
            isPositive: false,
            color: "#6f42c1",
          },
          {
            key: "totalPayments",
            label: "Tổng Thanh Toán",
            isPositive: false,
            color: "#6c757d",
          },
          {
            key: "netRevenue",
            label: "Doanh Thu Ròng",
            isPositive: true,
            color: "#007bff",
          },
        ];

        let currentTable = null;
        let allCostCenters = [];
        let selectedCostCenters = new Set();

        // Chart.js default configuration (wait for Chart to be available)
        $(document).ready(function () {
          // Ensure Chart.js is loaded before setting defaults
          if (typeof Chart !== "undefined") {
            Chart.defaults.font.family = "'Segoe UI', 'Roboto', sans-serif";
            Chart.defaults.color = "#495057";
          }
        });

        // Initialize Select2 for cost center selection
        $("#costCenterSelect").select2({
          theme: "bootstrap-5",
          placeholder: "Chọn trạm...",
          allowClear: true,
          closeOnSelect: false,
          width: "100%",
        });

        // Populate year dropdown
        const currentYear = new Date().getFullYear();
        const yearSelect = $("#yearSelect");

        for (let year = currentYear; year >= currentYear - 5; year--) {
          yearSelect.append(`<option value="${year}">${year}</option>`);
        }

        yearSelect.val(currentYear);

        // View toggle functionality
        $('input[name="viewOptions"]').on("change", function () {
          if ($(this).attr("id") === "tableView") {
            $("#tableViewContainer").show();
            $("#chartViewContainer").hide();
          } else {
            $("#tableViewContainer").hide();
            $("#chartViewContainer").show();
            updateCharts();
          }
        });

        // Chart control handlers
        $("#chartType, #chartMetric, #chartGroupBy").on("change", function () {
          updateCharts();
        });

        // Fetch cost centers and populate dropdown
        $.ajax({
          url: "/financeSummaryCostCenters",
          method: "GET",
          success: function (data) {
            allCostCenters = data;
            const costCenterSelect = $("#costCenterSelect");
            data.forEach((costCenter) => {
              costCenterSelect.append(
                `<option value="${costCenter.name}">${costCenter.name}</option>`
              );
            });

            // Set default to "all" and trigger Select2 update
            costCenterSelect.val(["all"]).trigger("change");
          },
          error: function () {
            console.error("Không thể tải danh sách trạm");
            alert("Lỗi khi tải danh sách trạm");
          },
        });

        // Handle "Tất Cả Trạm" selection logic
        $("#costCenterSelect").on("change", function () {
          const selectedValues = $(this).val();

          if (selectedValues && selectedValues.includes("all")) {
            // If "all" is selected, clear other selections
            if (selectedValues.length > 1) {
              $(this).val(["all"]).trigger("change");
            }
          }
        });

        // Clear selection button
        $("#clearSelection").on("click", function () {
          $("#costCenterSelect").val(["all"]).trigger("change");
        });

        // Update selected centers info
        function updateSelectedCentersInfo() {
          const selectedValues = $("#costCenterSelect").val();
          const infoElement = $("#selectedCentersInfo");

          if (
            !selectedValues ||
            selectedValues.length === 0 ||
            selectedValues.includes("all")
          ) {
            infoElement.text("Hiển thị: Tất cả trạm");
          } else {
            infoElement.text(
              `Hiển thị: ${
                selectedValues.length
              } trạm được chọn (${selectedValues.join(", ")})`
            );
          }
        }

        $("#costCenterSelect").on("change", updateSelectedCentersInfo);

        // Chart creation functions
        function createMainChart(data, chartType, metric, groupBy) {
          // Double-check Chart.js is available
          if (typeof Chart === "undefined") {
            console.error("Chart.js not available when creating main chart");
            return;
          }

          const ctx = document.getElementById("mainChart").getContext("2d");

          if (mainChart) {
            mainChart.destroy();
          }

          const metricInfo = metrics.find((m) => m.key === metric);
          let chartData, labels;

          if (groupBy === "month") {
            // Group by month
            const monthData = {};
            data.forEach((item) => {
              const monthKey = `${item.month}`;
              if (!monthData[monthKey]) {
                monthData[monthKey] = 0;
              }
              monthData[monthKey] += item[metric] || 0;
            });

            labels = Object.keys(monthData).sort((a, b) => {
              const [monthA, yearA] = a.split(" ");
              const [monthB, yearB] = b.split(" ");
              const yearDiff = parseInt(yearA) - parseInt(yearB);
              if (yearDiff !== 0) return yearDiff;
              return (monthOrder[monthA] || 0) - (monthOrder[monthB] || 0);
            });

            chartData = labels.map((label) => monthData[label]);
          } else {
            // Group by cost center
            const centerData = {};
            data.forEach((item) => {
              if (!centerData[item.costCenter]) {
                centerData[item.costCenter] = 0;
              }
              centerData[item.costCenter] += item[metric] || 0;
            });

            labels = Object.keys(centerData).sort();
            chartData = labels.map((label) => centerData[label]);
          }

          // Create gradient for area charts
          let backgroundColors;
          if (chartType === "area") {
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, metricInfo.color + "80");
            gradient.addColorStop(1, metricInfo.color + "20");
            backgroundColors = gradient;
          } else if (chartType === "pie") {
            backgroundColors = generateColors(labels.length);
          } else {
            backgroundColors = metricInfo.color;
          }

          const config = {
            type: chartType === "area" ? "line" : chartType,
            data: {
              labels: labels,
              datasets: [
                {
                  label: metricInfo.label,
                  data: chartData,
                  backgroundColor: backgroundColors,
                  borderColor: metricInfo.color,
                  borderWidth: 2,
                  fill: chartType === "area",
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: chartType === "pie",
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const value = context.parsed.y || context.parsed;
                      return `${context.dataset.label}: ${value.toLocaleString(
                        "vi-VN"
                      )} VNĐ`;
                    },
                  },
                },
              },
              scales:
                chartType !== "pie"
                  ? {
                      y: {
                        beginAtZero: true,
                        ticks: {
                          callback: function (value) {
                            return value.toLocaleString("vi-VN");
                          },
                        },
                      },
                    }
                  : {},
              // Force canvas size constraints
              onResize: function (chart, size) {
                chart.canvas.style.maxHeight = "350px";
              },
            },
          };

          mainChart = new Chart(ctx, config);

          // Update chart title
          $("#mainChartTitle").text(
            `${metricInfo.label} theo ${groupBy === "month" ? "Tháng" : "Trạm"}`
          );
        }

        function createNetRevenueChart(data) {
          if (typeof Chart === "undefined") {
            console.error(
              "Chart.js not available when creating net revenue chart"
            );
            return;
          }

          const ctx = document
            .getElementById("netRevenueChart")
            .getContext("2d");

          if (netRevenueChart) {
            netRevenueChart.destroy();
          }

          // Group data by month for net revenue only
          const monthlyData = {};
          data.forEach((item) => {
            const monthKey = `${item.month}`;
            if (!monthlyData[monthKey]) {
              monthlyData[monthKey] = 0;
            }
            monthlyData[monthKey] += item.netRevenue || 0;
          });

          const labels = Object.keys(monthlyData).sort((a, b) => {
            const [monthA, yearA] = a.split(" ");
            const [monthB, yearB] = b.split(" ");
            const yearDiff = parseInt(yearA) - parseInt(yearB);
            if (yearDiff !== 0) return yearDiff;
            return (monthOrder[monthA] || 0) - (monthOrder[monthB] || 0);
          });

          const chartData = labels.map((label) => monthlyData[label]);

          // Create gradient
          const gradient = ctx.createLinearGradient(0, 0, 0, 250);
          gradient.addColorStop(0, "#007bff80");
          gradient.addColorStop(1, "#007bff20");

          netRevenueChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Doanh Thu Ròng",
                  data: chartData,
                  backgroundColor: gradient,
                  borderColor: "#007bff",
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  pointBackgroundColor: "#007bff",
                  pointBorderColor: "#ffffff",
                  pointBorderWidth: 2,
                  pointRadius: 5,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false,
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const value = context.parsed.y;
                      return `Doanh thu ròng: ${value.toLocaleString(
                        "vi-VN"
                      )} VNĐ`;
                    },
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return value.toLocaleString("vi-VN");
                    },
                  },
                },
              },
              onResize: function (chart, size) {
                chart.canvas.style.maxHeight = "250px";
              },
            },
          });
        }

        function createComparisonChart(data) {
          if (typeof Chart === "undefined") {
            console.error(
              "Chart.js not available when creating comparison chart"
            );
            return;
          }

          const ctx = document
            .getElementById("comparisonChart")
            .getContext("2d");

          if (comparisonChart) {
            comparisonChart.destroy();
          }

          const totals = {
            totalSale: 0,
            totalPurchase: 0,
            totalTransport: 0,
            totalCommissionPurchase: 0,
            totalCommissionSale: 0,
            totalSalary: 0,
            totalPayments: 0,
          };

          data.forEach((item) => {
            totals.totalSale += item.totalSale || 0;
            totals.totalPurchase += item.totalPurchase || 0;
            totals.totalTransport += item.totalTransport || 0;
            totals.totalCommissionPurchase += item.totalCommissionPurchase || 0;
            totals.totalCommissionSale += item.totalCommissionSale || 0;
            totals.totalSalary += item.totalSalary || 0;
            totals.totalPayments += item.totalPayments || 0;
          });

          const labels = ["Thu nhập", "Chi phí"];
          const chartData = [
            totals.totalSale,
            totals.totalPurchase +
              totals.totalTransport +
              totals.totalCommissionPurchase +
              totals.totalCommissionSale +
              totals.totalSalary +
              totals.totalPayments,
          ];

          comparisonChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "VNĐ",
                  data: chartData,
                  backgroundColor: ["#28a745", "#dc3545"],
                  borderColor: ["#28a745", "#dc3545"],
                  borderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false,
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return `${
                        context.label
                      }: ${context.parsed.y.toLocaleString("vi-VN")} VNĐ`;
                    },
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return value.toLocaleString("vi-VN");
                    },
                  },
                },
              },
              // Force canvas size constraints
              onResize: function (chart, size) {
                chart.canvas.style.maxHeight = "250px";
              },
            },
          });
        }

        function createTrendChart(data) {
          if (typeof Chart === "undefined") {
            console.error("Chart.js not available when creating trend chart");
            return;
          }

          const ctx = document.getElementById("trendChart").getContext("2d");

          if (trendChart) {
            trendChart.destroy();
          }

          // Group data by month for all metrics
          const monthlyData = {};
          data.forEach((item) => {
            const monthKey = `${item.month}`;
            if (!monthlyData[monthKey]) {
              monthlyData[monthKey] = {
                totalSale: 0,
                totalPurchase: 0,
                netRevenue: 0,
                totalTransport: 0,
              };
            }
            monthlyData[monthKey].totalSale += item.totalSale || 0;
            monthlyData[monthKey].totalPurchase += item.totalPurchase || 0;
            monthlyData[monthKey].netRevenue += item.netRevenue || 0;
            monthlyData[monthKey].totalTransport += item.totalTransport || 0;
          });

          const labels = Object.keys(monthlyData).sort((a, b) => {
            const [monthA, yearA] = a.split(" ");
            const [monthB, yearB] = b.split(" ");
            const yearDiff = parseInt(yearA) - parseInt(yearB);
            if (yearDiff !== 0) return yearDiff;
            return (monthOrder[monthA] || 0) - (monthOrder[monthB] || 0);
          });

          const datasets = [
            {
              label: "Doanh Thu Ròng",
              data: labels.map((label) => monthlyData[label].netRevenue),
              borderColor: "#007bff",
              backgroundColor: "#007bff20",
              fill: false,
              tension: 0.4,
            },
            {
              label: "Tổng Bán Hàng",
              data: labels.map((label) => monthlyData[label].totalSale),
              borderColor: "#28a745",
              backgroundColor: "#28a74520",
              fill: false,
              tension: 0.4,
            },
            {
              label: "Tổng Mua Hàng",
              data: labels.map((label) => monthlyData[label].totalPurchase),
              borderColor: "#dc3545",
              backgroundColor: "#dc354520",
              fill: false,
              tension: 0.4,
            },
          ];

          trendChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: labels,
              datasets: datasets,
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "top",
                },
                tooltip: {
                  mode: "index",
                  intersect: false,
                  callbacks: {
                    label: function (context) {
                      return `${
                        context.dataset.label
                      }: ${context.parsed.y.toLocaleString("vi-VN")} VNĐ`;
                    },
                  },
                },
              },
              scales: {
                x: {
                  display: true,
                  title: {
                    display: true,
                    text: "Tháng",
                  },
                },
                y: {
                  display: true,
                  title: {
                    display: true,
                    text: "VNĐ",
                  },
                  ticks: {
                    callback: function (value) {
                      return value.toLocaleString("vi-VN");
                    },
                  },
                },
              },
              interaction: {
                mode: "nearest",
                axis: "x",
                intersect: false,
              },
              // Force canvas size constraints
              onResize: function (chart, size) {
                chart.canvas.style.maxHeight = "350px";
              },
            },
          });
        }

        function generateColors(count) {
          const colors = [
            "#FF6384",
            "#36A2EB",
            "#FFCE56",
            "#4BC0C0",
            "#9966FF",
            "#FF9F40",
            "#FF6384",
            "#C9CBCF",
            "#4BC0C0",
            "#FF6384",
            "#36A2EB",
            "#FFCE56",
          ];

          const result = [];
          for (let i = 0; i < count; i++) {
            result.push(colors[i % colors.length]);
          }
          return result;
        }

        function updateCharts() {
          if (!currentChartData.length || typeof Chart === "undefined") {
            if (typeof Chart === "undefined") {
              console.error("Chart.js not available when updating charts");
            }
            return;
          }

          const chartType = $("#chartType").val();
          const metric = $("#chartMetric").val();
          const groupBy = $("#chartGroupBy").val();

          createMainChart(currentChartData, chartType, metric, groupBy);
          createPieChart(currentChartData);
          createComparisonChart(currentChartData);
          createTrendChart(currentChartData);
        }

        // Improved Group Modal Functions
        function initializeCostCenterGrid() {
          const grid = $("#costCenterGrid");
          grid.empty();

          if (allCostCenters.length === 0) {
            grid.html(
              '<div class="text-center text-muted">Không có trạm nào</div>'
            );
            return;
          }

          allCostCenters.forEach((costCenter) => {
            const item = $(`
              <div class="cost-center-item" data-value="${costCenter.name}">
                <input type="checkbox" id="cc_${costCenter.name.replace(
                  /\s/g,
                  "_"
                )}" />
                <label for="cc_${costCenter.name.replace(
                  /\s/g,
                  "_"
                )}" style="margin-bottom: 0; cursor: pointer; flex: 1;">
                  ${costCenter.name}
                </label>
              </div>
            `);

            grid.append(item);
          });

          // Handle cost center item click
          $(".cost-center-item").on("click", function (e) {
            if (e.target.type !== "checkbox") {
              const checkbox = $(this).find('input[type="checkbox"]');
              checkbox.prop("checked", !checkbox.prop("checked"));
            }

            const costCenterName = $(this).data("value");
            const isChecked = $(this)
              .find('input[type="checkbox"]')
              .prop("checked");

            if (isChecked) {
              selectedCostCenters.add(costCenterName);
              $(this).addClass("selected");
            } else {
              selectedCostCenters.delete(costCenterName);
              $(this).removeClass("selected");
            }

            updateSelectedCount();
          });

          // Handle checkbox change
          $('.cost-center-item input[type="checkbox"]').on(
            "change",
            function () {
              const costCenterName = $(this)
                .closest(".cost-center-item")
                .data("value");
              const isChecked = $(this).prop("checked");

              if (isChecked) {
                selectedCostCenters.add(costCenterName);
                $(this).closest(".cost-center-item").addClass("selected");
              } else {
                selectedCostCenters.delete(costCenterName);
                $(this).closest(".cost-center-item").removeClass("selected");
              }

              updateSelectedCount();
            }
          );
        }

        function updateSelectedCount() {
          const count = selectedCostCenters.size;
          $("#selectedCount").text(`${count} trạm được chọn`);

          // Enable/disable save button
          $("#saveGroup").prop(
            "disabled",
            count === 0 || !$("#groupName").val().trim()
          );
        }

        // Selection action buttons
        $("#selectAll").on("click", function () {
          $(".cost-center-item").each(function () {
            const costCenterName = $(this).data("value");
            selectedCostCenters.add(costCenterName);
            $(this).addClass("selected");
            $(this).find('input[type="checkbox"]').prop("checked", true);
          });
          updateSelectedCount();
        });

        $("#clearAll").on("click", function () {
          $(".cost-center-item").each(function () {
            const costCenterName = $(this).data("value");
            selectedCostCenters.delete(costCenterName);
            $(this).removeClass("selected");
            $(this).find('input[type="checkbox"]').prop("checked", false);
          });
          updateSelectedCount();
        });

        $("#invertSelection").on("click", function () {
          $(".cost-center-item").each(function () {
            const costCenterName = $(this).data("value");
            const checkbox = $(this).find('input[type="checkbox"]');
            const isCurrentlyChecked = checkbox.prop("checked");

            if (isCurrentlyChecked) {
              selectedCostCenters.delete(costCenterName);
              $(this).removeClass("selected");
              checkbox.prop("checked", false);
            } else {
              selectedCostCenters.add(costCenterName);
              $(this).addClass("selected");
              checkbox.prop("checked", true);
            }
          });
          updateSelectedCount();
        });

        // Monitor group name input
        $("#groupName").on("input", function () {
          const hasName = $(this).val().trim();
          const hasSelection = selectedCostCenters.size > 0;
          $("#saveGroup").prop("disabled", !hasName || !hasSelection);
        });

        function saveCostCenterGroup() {
          const name = $("#groupName").val().trim();
          const costCenters = Array.from(selectedCostCenters);

          if (!name) {
            alert("Vui lòng nhập tên nhóm");
            return;
          }

          if (costCenters.length === 0) {
            alert("Vui lòng chọn ít nhất một trạm");
            return;
          }

          $.ajax({
            url: "/financeSummaryCostCenterGroups",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
              name,
              costCenters,
            }),
            success: function () {
              // Reset form
              $("#groupName").val("");
              selectedCostCenters.clear();
              $(".cost-center-item").removeClass("selected");
              $('.cost-center-item input[type="checkbox"]').prop(
                "checked",
                false
              );
              updateSelectedCount();

              // Reload groups list
              loadCostCenterGroups();

              // Show success message
              alert("Nhóm đã được tạo thành công!");
            },
            error: function (xhr) {
              const errorMsg = xhr.responseJSON?.message || "Lỗi khi lưu nhóm";
              alert(errorMsg);
            },
          });
        }

        $("#saveGroup").on("click", saveCostCenterGroup);

        // Function to create pivot table
        function createPivotTable(data) {
          // Destroy existing DataTable if it exists
          if (currentTable) {
            currentTable.destroy();
            currentTable = null;
          }

          // Group data by cost center and month
          const pivotData = {};
          const costCenters = new Set();
          const months = new Set();

          data.forEach((item) => {
            const centerMonthKey = `${item.costCenter}_${item.actualMonth}_${item.actualYear}`;
            costCenters.add(item.costCenter);
            months.add(`${item.actualMonth} ${item.actualYear}`);

            if (!pivotData[centerMonthKey]) {
              pivotData[centerMonthKey] = {
                costCenter: item.costCenter,
                month: `${item.actualMonth} ${item.actualYear}`,
                monthOrder: monthOrder[item.actualMonth] || 0,
                year: item.actualYear,
                totalSale: 0,
                totalPurchase: 0,
                totalTransport: 0,
                totalCommissionPurchase: 0,
                totalCommissionSale: 0,
                totalSalary: 0,
                totalPayments: 0,
                netRevenue: 0,
              };
            }

            const entry = pivotData[centerMonthKey];
            entry.totalSale += item.totalSale;
            entry.totalPurchase += item.totalPurchase;
            entry.totalTransport += item.totalTransport;
            entry.totalCommissionPurchase += item.totalCommissionPurchase;
            entry.totalCommissionSale += item.totalCommissionSale;
            entry.totalSalary += item.grossSalary;
            entry.totalPayments += item.totalPayments;
            entry.netRevenue =
              entry.totalSale -
              entry.totalPurchase -
              entry.totalTransport -
              entry.totalCommissionPurchase -
              entry.totalCommissionSale -
              entry.totalSalary -
              entry.totalPayments;
          });

          // Sort cost centers and months
          const sortedCostCenters = Array.from(costCenters).sort();
          const sortedMonths = Array.from(months).sort((a, b) => {
            const [monthA, yearA] = a.split(" ");
            const [monthB, yearB] = b.split(" ");
            const yearDiff = parseInt(yearA) - parseInt(yearB);
            if (yearDiff !== 0) return yearDiff;
            return (monthOrder[monthA] || 0) - (monthOrder[monthB] || 0);
          });

          // Create table header
          const tableHead = $("#tableHead");
          tableHead.empty();

          const headerRow = $("<tr></tr>");
          headerRow.append(
            '<th rowspan="2" class="metric-row" style="min-width: 180px; width: 180px;">Chi tiêu</th>'
          );

          sortedCostCenters.forEach((center) => {
            headerRow.append(
              `<th colspan="${sortedMonths.length}" class="center-header">${center}</th>`
            );
          });

          const subHeaderRow = $("<tr></tr>");
          sortedCostCenters.forEach((center) => {
            sortedMonths.forEach((month) => {
              subHeaderRow.append(
                `<th class="month-subheader" style="min-width: 120px;">${month}</th>`
              );
            });
          });

          tableHead.append(headerRow);
          tableHead.append(subHeaderRow);

          // Create table body
          const tableBody = $("#tableBody");
          tableBody.empty();

          metrics.forEach((metric) => {
            const row = $('<tr class="metric-row"></tr>');
            row.append(
              `<td style="min-width: 180px; width: 180px;">${metric.label}</td>`
            );

            sortedCostCenters.forEach((center) => {
              sortedMonths.forEach((month) => {
                const centerMonthKey = `${center}_${month.replace(" ", "_")}`;
                const entry = Object.values(pivotData).find(
                  (item) => item.costCenter === center && item.month === month
                );

                let value = 0;
                if (entry) {
                  value = entry[metric.key];
                }

                let cellClass = "";
                if (metric.isPositive && value > 0) cellClass = "positive";
                else if (!metric.isPositive && value > 0)
                  cellClass = "negative";
                else if (value < 0) cellClass = "negative";

                const formattedValue =
                  value === 0 ? "-" : value.toLocaleString("vi-VN");
                row.append(
                  `<td class="${cellClass}" style="min-width: 120px; text-align: right;">${formattedValue}</td>`
                );
              });
            });

            tableBody.append(row);
          });

          // Wait for DOM to be ready before initializing DataTable
          setTimeout(() => {
            // Initialize DataTable with specific configuration for pivot table
            currentTable = $("#revenueTable").DataTable({
              responsive: false,
              scrollX: true,
              scrollY: "500px",
              paging: false,
              searching: false,
              ordering: false,
              info: false,
              autoWidth: false,
              fixedColumns: {
                leftColumns: 1,
              },
              dom: "Bt",
              buttons: [
                {
                  extend: "excelHtml5",
                  text: "Xuất Excel",
                  className: "btn btn-success",
                  title: "Báo cáo doanh thu",
                  filename: function () {
                    const year = $("#yearSelect").val();
                    const selectedCostCenters = $("#costCenterSelect").val();
                    let fileName = `Bao_cao_doanh_thu_${year}`;

                    if (
                      selectedCostCenters &&
                      selectedCostCenters.length > 0 &&
                      !selectedCostCenters.includes("all")
                    ) {
                      fileName += `_${selectedCostCenters.join("_")}`;
                    }

                    return fileName;
                  },
                  customize: function (xlsx) {
                    const sheet = xlsx.xl.worksheets["sheet1.xml"];

                    // Add header information
                    const year = $("#yearSelect").val();
                    const selectedCostCenters = $("#costCenterSelect").val();
                    let costCenterText = "Tất cả trạm";

                    if (
                      selectedCostCenters &&
                      selectedCostCenters.length > 0 &&
                      !selectedCostCenters.includes("all")
                    ) {
                      costCenterText = selectedCostCenters.join(", ");
                    }

                    const titleRow = $("<row></row>").append(
                      $(
                        '<c r="A1" t="inlineStr" s="20"><is><t>Báo cáo doanh thu năm ' +
                          year +
                          " (Pivot)</t></is></c>"
                      )
                    );
                    const filterRow = $("<row></row>").append(
                      $(
                        '<c r="A2" t="inlineStr" s="20"><is><t>Trạm: ' +
                          costCenterText +
                          "</t></is></c>"
                      )
                    );

                    $("sheetData", sheet).prepend(filterRow);
                    $("sheetData", sheet).prepend(titleRow);
                  },
                  exportOptions: {
                    format: {
                      body: function (data, row, column, node) {
                        return data.replace(/\./g, "").replace(/,/g, "");
                      },
                    },
                  },
                },
              ],
              language: {
                decimal: "",
                emptyTable: "Không có dữ liệu trong bảng",
                processing: "Đang xử lý...",
                zeroRecords: "Không tìm thấy kết quả phù hợp",
              },
            });

            // Add the buttons to the DOM
            currentTable.buttons().container().appendTo($(".card-body .mb-3"));

            // Force column adjustment after initialization
            setTimeout(() => {
              if (currentTable) {
                currentTable.columns.adjust();
              }
            }, 100);
          }, 50);

          return Object.values(pivotData);
        }

        // Function to update budget summary
        function updateBudgetSummary(data, year) {
          const budgetContainer = $("#budgetSummaryContainer");
          const budgetDetails = $("#budgetDetails");

          if (year != 2025) {
            budgetContainer.hide();
            return;
          }

          let totalNetRevenue = 0;
          let totalSales = 0;
          let totalPurchases = 0;
          let totalTransport = 0;
          let totalCommissionPurchase = 0;
          let totalCommissionSale = 0;
          let totalSalary = 0;
          let totalPayments = 0;

          // Calculate totals
          data.forEach((item) => {
            totalSales += item.totalSale;
            totalPurchases += item.totalPurchase;
            totalTransport += item.totalTransport;
            totalCommissionPurchase += item.totalCommissionPurchase;
            totalCommissionSale += item.totalCommissionSale;
            totalSalary += item.totalSalary;
            totalPayments += item.totalPayments;
            totalNetRevenue += item.netRevenue;
          });

          const currentBudget = STARTING_BUDGET_2025 + totalNetRevenue;

          // Format numbers
          const format = (num) => num.toLocaleString("vi-VN");

          // Build HTML
          const html = `
            <div class="budget-item">
              <span>Ngân sách ban đầu:</span>
              <span>${format(STARTING_BUDGET_2025)} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng doanh thu bán hàng:</span>
              <span class="positive">${format(totalSales)} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng chi phí mua hàng:</span>
              <span class="negative">-${format(totalPurchases)} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng chi phí vận chuyển:</span>
              <span class="negative">-${format(totalTransport)} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng hoa hồng mua hàng:</span>
              <span class="negative">-${format(
                totalCommissionPurchase
              )} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng hoa hồng bán hàng:</span>
              <span class="negative">-${format(totalCommissionSale)} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng chi phí lương:</span>
              <span class="negative">-${format(totalSalary)} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng thanh toán khác:</span>
              <span class="negative">-${format(totalPayments)} VNĐ</span>
            </div>
            <div class="budget-item">
              <span>Tổng doanh thu ròng (2025):</span>
              <span class="${totalNetRevenue >= 0 ? "positive" : "negative"}">
                ${totalNetRevenue >= 0 ? "+" : ""}${format(totalNetRevenue)} VNĐ
              </span>
            </div>
            <div class="budget-item budget-total">
              <span>Ngân sách hiện tại:</span>
              <span class="${
                currentBudget >= STARTING_BUDGET_2025 ? "positive" : "negative"
              }">
                ${format(currentBudget)} VNĐ
              </span>
            </div>
          `;

          budgetDetails.html(html);
          budgetContainer.show();
        }

        $("#filterForm").on("submit", function (e) {
          e.preventDefault();
          const year = $("#yearSelect").val();
          const selectedCostCenters = $("#costCenterSelect").val();

          // Build the query parameters for multiple cost centers
          let queryParams = `year=${year}`;
          if (
            selectedCostCenters &&
            selectedCostCenters.length > 0 &&
            !selectedCostCenters.includes("all")
          ) {
            queryParams += `&costCenters=${selectedCostCenters.join(",")}`;
          }

          $.ajax({
            url: `/financeSummaryRevenueByCostCenter?${queryParams}`,
            method: "GET",
            success: function (data) {
              if (data.length === 0) {
                alert("Không tìm thấy dữ liệu cho năm đã chọn");
                $("#tableBody").html(
                  '<tr><td colspan="100%" class="text-center text-muted">Không có dữ liệu</td></tr>'
                );
                $("#budgetSummaryContainer").hide();
                currentChartData = [];
                return;
              }

              const pivotData = createPivotTable(data);
              currentChartData = pivotData;
              updateSelectedCentersInfo();
              updateBudgetSummary(pivotData, year);

              // Update charts if chart view is active
              if ($("#chartView").is(":checked")) {
                updateCharts();
              }
            },
            error: function (xhr, status, error) {
              alert("Lỗi khi tải dữ liệu: " + error);
            },
          });
        });

        // Group Management Functions
        function loadCostCenterGroups() {
          $("#groupList").html(
            '<div class="list-group-item text-muted text-center">Đang tải nhóm...</div>'
          );

          $.ajax({
            url: "/financeSummaryCostCenterGroups",
            method: "GET",
            success: function (groups) {
              const groupList = $("#groupList");
              groupList.empty();

              if (groups.length === 0) {
                groupList.html(
                  '<div class="list-group-item text-muted text-center">Bạn chưa có nhóm nào</div>'
                );
                return;
              }

              groups.forEach((group) => {
                const groupItem = $(`
                  <div class="list-group-item group-item d-flex justify-content-between align-items-center">
                    <div style="flex: 1; cursor: pointer;">
                      <strong>${group.name}</strong>
                      <div class="text-muted small">${
                        group.costCenters.length
                      } trạm</div>
                      <div class="text-muted small" style="font-size: 0.75em;">${group.costCenters.join(
                        ", "
                      )}</div>
                    </div>
                    <div>
                      <button class="btn btn-sm btn-outline-danger delete-group" data-id="${
                        group._id
                      }" title="Xóa nhóm">
                        ✕
                      </button>
                    </div>
                  </div>
                `);

                groupItem.on("click", ".delete-group", function (e) {
                  e.stopPropagation();
                  const groupId = $(this).data("id");
                  deleteCostCenterGroup(groupId);
                });

                groupItem
                  .find('div[style*="cursor: pointer"]')
                  .on("click", function () {
                    applyGroupFilter(group.costCenters);
                  });

                groupList.append(groupItem);
              });
            },
            error: function () {
              $("#groupList").html(
                '<div class="list-group-item text-danger text-center">Lỗi khi tải nhóm</div>'
              );
            },
          });
        }

        function applyGroupFilter(costCenters) {
          $("#costCenterSelect").val(costCenters).trigger("change");
          $("#groupModal").modal("hide");
          $("#filterForm").trigger("submit");
        }

        function deleteCostCenterGroup(groupId) {
          if (!confirm("Bạn có chắc chắn muốn xóa nhóm này không?")) return;

          $.ajax({
            url: `/financeSummaryCostCenterGroups/${groupId}`,
            method: "DELETE",
            success: function () {
              loadCostCenterGroups();
              alert("Nhóm đã được xóa thành công!");
            },
            error: function () {
              alert("Lỗi khi xóa nhóm");
            },
          });
        }

        // Initialize the group management modal when shown
        $("#groupModal").on("shown.bs.modal", function () {
          // Initialize the cost center grid
          initializeCostCenterGrid();

          // Load existing groups
          loadCostCenterGroups();

          // Reset form state
          selectedCostCenters.clear();
          $("#groupName").val("");
          updateSelectedCount();
        });

        // Reset modal state when hidden
        $("#groupModal").on("hidden.bs.modal", function () {
          selectedCostCenters.clear();
          $("#groupName").val("");
          $("#costCenterGrid").empty();
        });

        // Initial load
        $("#filterForm").trigger("submit");
      });
    </script>
  </body>
</html>
