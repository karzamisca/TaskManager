<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Management</title>
  </head>
  <body>
    <div id="app">
      <h1>Project Management</h1>

      <!-- Create New Project -->
      <div id="create-project">
        <h2>Create New Project</h2>
        <form id="create-project-form" onsubmit="createProject(event)">
          <label for="project-title">Title:</label>
          <input
            type="text"
            id="project-title"
            placeholder="Enter project title"
            required
          />
          <label for="project-description">Description:</label>
          <textarea
            id="project-description"
            placeholder="Enter project description"
            required
          ></textarea>
          <button type="submit">Create Project</button>
        </form>
      </div>

      <!-- List of Projects -->
      <div id="project-list">
        <h2>Your Projects</h2>
        <ul id="projects">
          <!-- Project list items will be dynamically added here -->
        </ul>
      </div>

      <!-- Project Details -->
      <div id="project-details" style="display: none">
        <h2 id="project-details-title"></h2>
        <p id="project-details-description"></p>

        <!-- Proposal Phase -->
        <div id="phase-proposal">
          <h3>Proposal Phase</h3>
          <form id="proposal-form" onsubmit="updatePhase('proposal', event)">
            <label for="proposal-task">Task:</label>
            <input
              type="text"
              id="proposal-task"
              placeholder="Enter task"
              required
            />
            <label for="proposal-cost-center">Cost Center:</label>
            <input
              type="text"
              id="proposal-cost-center"
              placeholder="Enter cost center"
              required
            />
            <label for="proposal-date-of-error">Date of Error:</label>
            <input
              type="text"
              id="proposal-date-of-error"
              placeholder="Enter date of error"
              required
            />
            <label for="proposal-details-description"
              >Details Description:</label
            >
            <textarea
              id="proposal-details-description"
              placeholder="Enter details description"
              required
            ></textarea>
            <label for="proposal-direction">Direction:</label>
            <input
              type="text"
              id="proposal-direction"
              placeholder="Enter direction"
              required
            />
            <button type="submit">Submit</button>
            <button type="button" onclick="approvePhase('proposal')">
              Approve
            </button>
          </form>
        </div>

        <!-- Purchasing Phase -->
        <div id="phase-purchasing">
          <h3>Purchasing Phase</h3>
          <form
            id="purchasing-form"
            onsubmit="updatePhase('purchasing', event)"
          >
            <label for="purchasing-title">Title:</label>
            <input
              type="text"
              id="purchasing-title"
              placeholder="Enter title"
              required
            />
            <div id="purchasing-products">
              <!-- Product fields will be dynamically added here -->
            </div>
            <button type="button" onclick="addProduct()">Add Product</button>
            <label for="purchasing-grand-total-cost">Grand Total Cost:</label>
            <input
              type="number"
              id="purchasing-grand-total-cost"
              placeholder="Enter grand total cost"
              readonly
            />
            <button type="submit">Submit</button>
            <button type="button" onclick="approvePhase('purchasing')">
              Approve
            </button>
          </form>
        </div>

        <!-- Payment Phase -->
        <div id="phase-payment">
          <h3>Payment Phase</h3>
          <form id="payment-form" onsubmit="updatePhase('payment', event)">
            <label for="payment-title">Title:</label>
            <input
              type="text"
              id="payment-title"
              placeholder="Enter title"
              required
            />
            <label for="payment-payment-method">Payment Method:</label>
            <input
              type="text"
              id="payment-payment-method"
              placeholder="Enter payment method"
              required
            />
            <label for="payment-amount-of-money">Amount of Money:</label>
            <input
              type="number"
              id="payment-amount-of-money"
              placeholder="Enter amount"
              required
            />
            <label for="payment-paid">Paid:</label>
            <input
              type="number"
              id="payment-paid"
              placeholder="Enter paid amount"
              required
            />
            <label for="payment-payment-deadline">Payment Deadline:</label>
            <input
              type="text"
              id="payment-payment-deadline"
              placeholder="Enter payment deadline"
              required
            />
            <button type="submit">Submit</button>
            <button type="button" onclick="approvePhase('payment')">
              Approve
            </button>
          </form>
        </div>
      </div>
    </div>
    <script>
      let token = null;
      let currentProjectId = null;
      let currentUserRole = null;
      let currentProject = null;
      let currentUserId = null;
      let productCount = 0;

      // Fetch user role and ID
      async function fetchUserRole() {
        const response = await fetch("/getRoleProjectDocument", {
          credentials: "include", // Include cookies
        });
        const data = await response.json();
        currentUserRole = data.role;
        currentUserId = data._id; // Use _id instead of userId
        console.log("Current user role:", currentUserRole); // Debugging
        console.log("Current user ID:", currentUserId); // Debugging
      }

      // Create a new project
      async function createProject(event) {
        event.preventDefault(); // Prevent default form submission
        const title = document.getElementById("project-title").value;
        const description = document.getElementById(
          "project-description"
        ).value;

        const response = await fetch("/createProjectDocument", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include", // Include cookies
          body: JSON.stringify({ title, description }),
        });

        const data = await response.json();
        if (response.ok) {
          alert("Project created successfully");
          loadProjects(); // Reload the project list
        } else {
          alert(data.message);
        }
      }

      // Load all projects
      async function loadProjects() {
        const response = await fetch("/getAllProjectDocuments", {
          credentials: "include", // Include cookies
        });
        const projects = await response.json();
        console.log("Projects loaded:", projects); // Debugging

        const projectList = document.getElementById("projects");
        projectList.innerHTML = "";

        projects.forEach((project) => {
          const li = document.createElement("li");
          li.textContent = project.title;
          li.setAttribute("data-project-id", project._id); // Attach projectId
          li.onclick = () => loadProject(project._id); // Load project details
          projectList.appendChild(li);
        });
      }

      // Load project details
      async function loadProject(projectId) {
        console.log("Loading project with ID:", projectId); // Debugging
        currentProjectId = projectId; // Set the current project ID

        const response = await fetch(`/getProjectDocument/${projectId}`, {
          credentials: "include", // Include cookies
        });
        const data = await response.json();
        console.log("Project data from backend:", data); // Debugging

        if (!response.ok) {
          alert(data.message || "Failed to load project");
          return;
        }

        currentProject = data; // Store the current project data
        document.getElementById("project-details").style.display = "block";
        document.getElementById("project-details-title").innerText = data.title;
        document.getElementById("project-details-description").innerText =
          data.description;

        // Initialize productCount based on the number of existing products
        if (data.phases.purchasing && data.phases.purchasing.products) {
          productCount = data.phases.purchasing.products.length;
        } else {
          productCount = 0; // Reset if no products exist
        }

        // Lock phases based on their status
        lockPhase("proposal", data.phases.proposal);
        lockPhase("purchasing", data.phases.purchasing);
        lockPhase("payment", data.phases.payment);
      }

      // Lock a phase if it's approved
      function lockPhase(phase, phaseData) {
        console.log(`Checking ${phase} phase status...`); // Debugging
        console.log("Phase data:", phaseData); // Debugging

        const form = document.getElementById(`${phase}-form`);
        const submitButton = form.querySelector("button[type='submit']");
        const approveButton = form.querySelector(
          "button[onclick*='approvePhase']"
        );
        const addProductButton = document.querySelector(
          "#purchasing-form button[onclick*='addProduct']"
        );

        // Populate form fields
        if (phase === "purchasing") {
          const productsDiv = document.getElementById("purchasing-products");
          productsDiv.innerHTML = ""; // Clear existing products

          // Populate products
          phaseData.products.forEach((product, index) => {
            const productDiv = document.createElement("div");
            productDiv.innerHTML = `
              <h4>Product ${index + 1}</h4>
              <label for="purchasing-product-name-${index}">Product Name:</label>
              <input
                type="text"
                id="purchasing-product-name-${index}"
                value="${product.productName}"
                ${phaseData.status !== "Pending" ? "disabled" : ""}
                required
              />
              <label for="purchasing-cost-per-unit-${index}">Cost Per Unit:</label>
              <input
                type="number"
                id="purchasing-cost-per-unit-${index}"
                value="${product.costPerUnit}"
                ${phaseData.status !== "Pending" ? "disabled" : ""}
                required
              />
              <label for="purchasing-amount-${index}">Amount:</label>
              <input
                type="number"
                id="purchasing-amount-${index}"
                value="${product.amount}"
                ${phaseData.status !== "Pending" ? "disabled" : ""}
                required
              />
              <label for="purchasing-total-cost-${index}">Total Cost:</label>
              <input
                type="number"
                id="purchasing-total-cost-${index}"
                value="${product.totalCost}"
                readonly
              />
              <label for="purchasing-note-${index}">Note:</label>
              <input
                type="text"
                id="purchasing-note-${index}"
                value="${product.note}"
                ${phaseData.status !== "Pending" ? "disabled" : ""}
                required
              />
            `;
            productsDiv.appendChild(productDiv);
          });

          // Populate grand total cost
          document.getElementById("purchasing-grand-total-cost").value =
            phaseData.grandTotalCost;

          // Populate the title field
          document.getElementById("purchasing-title").value =
            phaseData.title || "";

          // Enable or disable the "Add Product" button based on phase status
          if (addProductButton) {
            addProductButton.disabled = phaseData.status !== "Pending";
          }
        } else if (phase === "proposal") {
          // Populate proposal phase fields
          document.getElementById("proposal-task").value = phaseData.task || "";
          document.getElementById("proposal-cost-center").value =
            phaseData.costCenter || "";
          document.getElementById("proposal-date-of-error").value =
            phaseData.dateOfError || "";
          document.getElementById("proposal-details-description").value =
            phaseData.detailsDescription || "";
          document.getElementById("proposal-direction").value =
            phaseData.direction || "";
        } else if (phase === "payment") {
          // Populate payment phase fields
          document.getElementById("payment-title").value =
            phaseData.title || "";
          document.getElementById("payment-payment-method").value =
            phaseData.paymentMethod || "";
          document.getElementById("payment-amount-of-money").value =
            phaseData.amountOfMoney || "";
          document.getElementById("payment-paid").value = phaseData.paid || "";
          document.getElementById("payment-payment-deadline").value =
            phaseData.paymentDeadline || "";
        }

        // Handle phase status
        if (phaseData.status === "Pending") {
          console.log(
            `Phase ${phase} is pending. Enabling inputs and approval.`
          ); // Debugging
          form.querySelectorAll("input, textarea").forEach((element) => {
            element.disabled = false;
          });
          submitButton.disabled = false; // Enable the submit button
          approveButton.disabled = !canApprovePhase(phase); // Allow approval if the user can approve
        } else if (phaseData.status === "Locked") {
          console.log(
            `Phase ${phase} is locked. Disabling inputs and approval.`
          ); // Debugging
          form
            .querySelectorAll("input, textarea, button")
            .forEach((element) => {
              element.disabled = true;
            });
        } else if (phaseData.status === "Partially Approved") {
          console.log(
            `Phase ${phase} is partially approved. Disabling inputs but allowing approval.`
          ); // Debugging
          form.querySelectorAll("input, textarea").forEach((element) => {
            element.disabled = true;
          });
          submitButton.disabled = true; // Disable the submit button
          approveButton.disabled = !canApprovePhase(phase); // Allow approval if the user can approve
        } else if (phaseData.status === "Approved") {
          console.log(
            `Phase ${phase} is fully approved. Locking inputs and buttons.`
          ); // Debugging
          form
            .querySelectorAll("input, textarea, button")
            .forEach((element) => {
              element.disabled = true;
            });
        }

        console.log("Submit button state:", submitButton.disabled); // Debugging
        console.log("Approve button state:", approveButton.disabled); // Debugging
      }

      // Check if the current user can approve the phase
      function canApprovePhase(phase) {
        console.log("Checking if user can approve phase:", phase); // Debugging
        console.log("Current user role:", currentUserRole); // Debugging
        console.log("Current user ID:", currentUserId); // Debugging
        console.log("Current project data:", currentProject); // Debugging

        if (phase === "proposal" && currentUserRole === "approver") return true;
        if (phase === "purchasing" && currentUserRole === "approver")
          return true;
        if (
          phase === "payment" &&
          (currentUserRole === "approver" || currentUserRole === "Director")
        ) {
          // Check if the user has already approved the payment phase
          if (currentProject && currentProject.phases.payment.approvedBy) {
            const userHasApproved =
              currentProject.phases.payment.approvedBy.some(
                (approverId) => approverId === currentUserId
              );
            if (userHasApproved) {
              console.log("User has already approved this phase."); // Debugging
              return false; // User has already approved
            }
          }
          return true;
        }
        return false;
      }

      async function approvePhase(phase) {
        if (!currentProjectId) {
          alert("No project selected. Please select a project first.");
          return;
        }

        console.log(
          `Attempting to approve ${phase} phase for project ${currentProjectId}...`
        ); // Debugging
        console.log("Current user role:", currentUserRole); // Debugging

        // Check if the user has the correct role to approve the phase
        if (!canApprovePhase(phase)) {
          alert("You do not have permission to approve this phase.");
          return;
        }

        const response = await fetch("/approvePhaseProjectDocument", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include", // Include cookies
          body: JSON.stringify({ projectId: currentProjectId, phase }),
        });

        const data = await response.json();
        if (response.ok) {
          alert("Phase approved successfully");
          console.log("Updated project data:", data); // Debugging
          loadProject(currentProjectId); // Reload project details
        } else {
          alert(data.message);
        }
      }

      async function updatePhase(phase, event) {
        event.preventDefault(); // Prevent default form submission
        if (!currentProjectId) {
          alert("No project selected. Please select a project first.");
          return;
        }

        const form = document.getElementById(`${phase}-form`);
        const details = {};

        // Collect phase details from the form
        form.querySelectorAll("input, textarea").forEach((input) => {
          const key = input.id.replace(`${phase}-`, "");
          if (input.value) {
            details[key] = input.value;
          }
        });

        console.log("Sending phase details:", details); // Debugging

        const response = await fetch("/updatePhaseDetailsProjectDocument", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include", // Include cookies
          body: JSON.stringify({
            projectId: currentProjectId,
            phase,
            details,
          }),
        });

        const data = await response.json();
        if (response.ok) {
          alert("Phase details updated successfully");
          loadProject(currentProjectId); // Reload project details
        } else {
          alert(data.message);
        }
      }

      function addProduct() {
        const productDiv = document.createElement("div");
        productDiv.innerHTML = `
          <h4>Product ${productCount + 1}</h4>
          <label for="purchasing-product-name-${productCount}">Product Name:</label>
          <input
            type="text"
            id="purchasing-product-name-${productCount}"
            placeholder="Enter product name"
            required
          />
          <label for="purchasing-cost-per-unit-${productCount}">Cost Per Unit:</label>
          <input
            type="number"
            id="purchasing-cost-per-unit-${productCount}"
            placeholder="Enter cost per unit"
            required
          />
          <label for="purchasing-amount-${productCount}">Amount:</label>
          <input
            type="number"
            id="purchasing-amount-${productCount}"
            placeholder="Enter amount"
            required
          />
          <label for="purchasing-total-cost-${productCount}">Total Cost:</label>
          <input
            type="number"
            id="purchasing-total-cost-${productCount}"
            placeholder="Total cost"
            readonly
          />
          <label for="purchasing-note-${productCount}">Note:</label>
          <input
            type="text"
            id="purchasing-note-${productCount}"
            placeholder="Enter note"
            required
          />
        `;
        document.getElementById("purchasing-products").appendChild(productDiv);
        productCount++; // Increment the product count
      }

      // On page load
      window.onload = async () => {
        await fetchUserRole();
        await loadProjects();
      };
    </script>
  </body>
</html>
