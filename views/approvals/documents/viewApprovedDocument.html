<!-- views/approvals/documents/viewApprovedDocument.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phiếu đã phê duyệt/View Approved Documents</title>
    <style>
      /* Base Theme Variables */
      :root {
        --main-bg-color: #3498db;
        --header-bg-color: #555;
        --header-text-color: white;
        --border-color: #ddd;
        --hover-bg-color: #f5f5f5;
        --font-size-base: 16px;

        --container-bg-color: white;
        --body-bg-color: #f9f9f9;
        --text-color: #333;
        --link-color: #3498db;
        --button-bg-color: #3498db;
        --button-hover-bg-color: darkred;

        --card-bg-color: #fff;
        --table-border-color: #ddd;
        --nested-proposal-bg: #f8f9fa;
        --nested-proposal-border: #e9ecef;
        --nested-proposal-strong: #2c3e50;
      }

      /* Dark Mode Variables */
      @media (prefers-color-scheme: dark) {
        :root {
          --main-bg-color: #2c3e50;
          --header-bg-color: #1e272e;
          --header-text-color: #f1f1f1;
          --border-color: #444;
          --hover-bg-color: #3a3a3a;

          --container-bg-color: #1e272e;
          --body-bg-color: #121212;
          --text-color: #f1f1f1;
          --link-color: #81b3f4;
          --button-bg-color: #81b3f4;
          --button-hover-bg-color: #3498db;

          --card-bg-color: #2d2d2d;
          --table-border-color: #404040;
          --nested-proposal-bg: #1a232c;
          --nested-proposal-border: #505050;
          --nested-proposal-strong: #b8c5d9;
        }
      }

      /* Global Styles */
      body {
        font-family: Arial, sans-serif;
        background-color: var(--body-bg-color);
        color: var(--text-color);
        margin: 1rem;
        font-size: calc(var(--font-size-base) * 1rem);
      }

      .container {
        background-color: var(--container-bg-color);
        max-width: 1200px;
        margin: auto;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      h2 {
        color: var(--text-color);
        margin-top: 2rem;
        border-bottom: 2px solid var(--main-bg-color);
        padding-bottom: 0.5rem;
        font-size: 1.5rem;
      }

      .table-container {
        max-height: 40vh;
        overflow: auto;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        margin-bottom: 1rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }

      .nested-proposals {
        display: flex;
        flex-direction: row;
        gap: 1rem;
        overflow-x: auto;
        border: 1px solid var(--nested-proposal-border);
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 4px;
        background-color: var(--nested-proposal-bg);
      }

      .nested-proposals p {
        margin: 0.5rem 0;
        line-height: 1.4;
      }

      .nested-proposals strong {
        color: var(--nested-proposal-strong);
        font-weight: 600;
      }

      .nested-proposals a {
        display: inline-block;
        margin-top: 0.25rem;
      }

      .nested-proposals > div {
        flex: 0 0 auto;
        min-width: 300px;
        padding: 1rem;
        border: 1px solid var(--table-border-color);
        border-radius: 8px;
        background-color: var(--card-bg-color);
        box-shadow: var(--shadow-light);
      }

      .nested-proposals > div p {
        margin: 0.5rem 0;
      }

      td {
        border: 1px solid var(--border-color);
        padding: 0.75rem;
        text-align: left;
        word-wrap: break-word;
      }

      th {
        background-color: var(--main-bg-color);
        color: var(--header-text-color);
      }

      tbody tr:hover {
        background-color: var(--hover-bg-color);
      }

      a {
        text-decoration: none;
        color: var(--link-color);
        font-weight: bold;
      }

      a:hover {
        color: darkred;
      }

      button {
        background-color: var(--button-bg-color);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-radius: 5px;
      }

      button:hover {
        background-color: var(--button-hover-bg-color);
      }

      /* Responsive Styling for Smaller Screens */
      @media (max-width: 768px) {
        h2 {
          font-size: 1.2rem;
        }

        th,
        td {
          padding: 0.5rem;
        }

        button {
          padding: 0.4rem 0.8rem;
          font-size: 0.85rem;
        }
      }

      @media (max-width: 480px) {
        body {
          font-size: 0.85rem;
        }

        h2 {
          font-size: 1rem;
        }

        th,
        td {
          font-size: 0.75rem;
          padding: 0.4rem;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2>Phiếu chung đã phê duyệt/Approved Generic Documents</h2>
      <div class="table-container">
        <table id="approved-generic-documents">
          <thead>
            <tr>
              <th>Mã/ID</th>
              <th>Nội dung/Content</th>
              <th>Tệp đính kèm/Attached File</th>
              <th>Được phê duyệt bởi/Approved By</th>
              <th>Nộp bởi/Submitted By</th>
              <th>Hành động/Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="6">Đang tải/Loading documents...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>Phiếu đề xuất đã phê duyệt/Approved Proposal Documents</h2>
      <div class="table-container">
        <table id="approved-proposal-documents">
          <thead>
            <tr>
              <th>Mã/ID</th>
              <th>Công việc/Task</th>
              <th>Trạm/Center</th>
              <th>Ngày xảy ra lỗi/Date of Error</th>
              <th>Mô tả chi tiết/Details Description</th>
              <th>Hướng xử lý/Direction</th>
              <th>Tệp đính kèm/Attached File</th>
              <th>Được phê duyệt bởi/Approved By</th>
              <th>Nộp bởi/Submitted By</th>
              <th>Hành động/Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="10">Đang tải/Loading documents...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>Phiếu mua hàng đã phê duyệt/Approved Purchasing Documents</h2>
      <div class="table-container">
        <table id="approved-purchasing-documents">
          <thead>
            <tr>
              <th>Mã/ID</th>
              <th>Danh sách sản phẩm/Product Entries</th>
              <th>Chi phí/Grand Total Cost</th>
              <th>Tệp đính kèm/Attached File</th>
              <th>Phiếu đề xuất kèm theo/Appended Proposal Content</th>
              <th>Được phê duyệt bởi/Approved By</th>
              <th>Nộp bởi/Submitted By</th>
              <th>Hành động/Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="8">Đang tải/Loading documents...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>Phiếu thanh toán đã phê duyệt/Approved Payment Documents</h2>
      <div class="table-container">
        <table id="approved-payment-documents">
          <thead>
            <tr>
              <th>Mã/ID</th>
              <th>Tên/Name</th>
              <th>Phương thức thanh toán/Payment Method</th>
              <th>Số tiền/Amount of Money</th>
              <th>Đã thanh toán/Paid</th>
              <th>Hạn thanh toán/Payment Deadline</th>
              <th>Phiếu mua hàng đi kèm/Appended Purchasing Documents</th>
              <th>Phiếu đề xuất đi kèm/Appended Proposals</th>
              <th>Tệp đính kèm/Attached File</th>
              <th>Được phê duyệt bởi/Approved By</th>
              <th>Nộp bởi/Submitted By</th>
              <th>Hành động/Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="8">Đang tải/Loading documents...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <a href="/mainDocument">Trở về/Back</a>
    </div>

    <script>
      async function exportToDocx(docId) {
        try {
          const response = await fetch(`/exportDocumentToDocx/${docId}`);
          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = "document.docx";
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
          } else {
            alert("Failed to export document!");
          }
        } catch (error) {
          console.error("Error exporting document:", error);
          alert("An error occurred while exporting the document.");
        }
      }

      async function fetchApprovedDocuments() {
        const response = await fetch("/approvedDocument");
        if (!response.ok) throw new Error("Failed to fetch documents");

        const documents = await response.json();

        const genericTableBody = document.querySelector(
          "#approved-generic-documents tbody"
        );
        const proposalTableBody = document.querySelector(
          "#approved-proposal-documents tbody"
        );
        const purchasingTableBody = document.querySelector(
          "#approved-purchasing-documents tbody"
        );
        const paymentTableBody = document.querySelector(
          "#approved-payment-documents tbody"
        );

        genericTableBody.innerHTML = "";
        proposalTableBody.innerHTML = "";
        purchasingTableBody.innerHTML = "";
        paymentTableBody.innerHTML = "";

        if (documents.length === 0) {
          genericTableBody.innerHTML =
            "<tr><td colspan='6'>Chưa có phiếu chung đã duyệt/No approved generic documents.</td></tr>";
          proposalTableBody.innerHTML =
            "<tr><td colspan='10'>Chưa có phiếu đề xuất đã duyệt/No approved proposal documents.</td></tr>";
          purchasingTableBody.innerHTML =
            "<tr><td colspan='8'>Chưa có phiếu mua hàng đã duyệt/No approved purchasing documents.</td></tr>";
          paymentTableBody.innerHTML =
            "<tr><td colspan='8'>Chưa có phiếu thanh toán đã duyệt/No approved payment documents.</td></tr>";
          return;
        }

        documents.forEach((doc) => {
          const approversHTML = doc.approvers
            .map((approver) => {
              const approvedInfo = doc.approvedBy.find(
                (approved) => approved.username === approver.username
              );
              if (approvedInfo && approvedInfo.approvalDate) {
                return `${approvedInfo.username} (${approver.subRole}) (${approvedInfo.approvalDate})<br>`;
              }
              return "";
            })
            .filter((html) => html !== "")
            .join("");

          const fileMetadataHTML = doc.fileMetadata
            ? `<a href="${doc.fileMetadata.link}" target="_blank">${doc.fileMetadata.name}</a>`
            : "Không có tệp đính kèm/No File Attached";

          if (doc.title === "Generic Document") {
            const contentTableRows = doc.content
              .map(
                (item) => `<tr><td>${item.name}</td><td>${item.text}</td></tr>`
              )
              .join("");
            const contentTable = `
              <table class="nested-table">
                <thead><tr><th>Tên/Name</th><th>Nội dung/Text</th></tr></thead>
                <tbody>${contentTableRows}</tbody>
              </table>`;
            const row = `
              <tr>
                <td>${doc._id}</td>
                <td>${contentTable}</td>
                <td>${fileMetadataHTML}</td>
                <td>${approversHTML}</td>
                <td>${doc.submittedBy.username} (${doc.submissionDate})</td>
                <td>
                  <form action="/exportDocumentToDocx/${doc._id}" method="GET" style="display:inline;" onsubmit="return confirmExport()">
                    <button type="submit">Xuất ra DOCX/Export to DOCX</button>
                  </form>
                </td>
              </tr>`;
            genericTableBody.insertAdjacentHTML("beforeend", row);
          } else if (doc.title === "Proposal Document") {
            const row = `
              <tr>
                <td>${doc._id}</td>
                <td>${doc.task}</td>
                <td>${doc.costCenter}</td>
                <td>${doc.dateOfError}</td>
                <td>${doc.detailsDescription}</td>
                <td>${doc.direction}</td>
                <td>${fileMetadataHTML}</td>
                <td>${approversHTML}</td>
                <td>${doc.submittedBy.username} (${doc.submissionDate})</td>
                <td>
                  <form action="/exportDocumentToDocx/${doc._id}" method="GET" style="display:inline;" onsubmit="return confirmExport()">
                    <button type="submit">Xuất ra DOCX/Export to DOCX</button>
                  </form>
                </td>
              </tr>`;
            proposalTableBody.insertAdjacentHTML("beforeend", row);
          } else if (doc.title === "Purchasing Document") {
            // Generate the product table rows
            const productRows = doc.products
              .map(
                (product) => `
                  <tr>
                    <td>${product.productName}</td>
                    <td>${product.costPerUnit.toLocaleString()}</td>
                    <td>${product.amount.toLocaleString()}</td>
                    <td>${product.note || "N/A"}</td>
                    <td>${product.totalCost.toLocaleString()}</td>
                  </tr>
                `
              )
              .join("");

            const productTable = `
              <table class="nested-table">
                <thead>
                  <tr>
                    <th>Tên sản phẩm/Product Name</th>
                    <th>Đơn giá/Cost per Unit</th>
                    <th>Số lượng/Amount</th>
                    <th>Ghi chú/Note</th>
                    <th>Thành tiền/Total Cost</th>
                  </tr>
                </thead>
                <tbody>${productRows}</tbody>
              </table>
            `;

            // Generate appended proposals content
            const appendedProposalsContent = `
              <div class="nested-proposals">
                ${doc.appendedProposals
                  .map(
                    (proposal) => `
                      <div>
                        <p><strong>Mã phiếu đề xuất/Proposal ID:</strong> ${
                          proposal.proposalId || "N/A"
                        }</p>
                        <p><strong>Công việc/Task:</strong> ${
                          proposal.task || "N/A"
                        }</p>
                        <p><strong>Trạm/Center:</strong> ${
                          proposal.costCenter || "N/A"
                        }</p>
                        <p><strong>Ngày xảy ra lỗi/Date of Error:</strong> ${
                          proposal.dateOfError || "N/A"
                        }</p>
                        <p><strong>Mô tả chi tiết/Details Description:</strong> ${
                          proposal.detailsDescription || "N/A"
                        }</p>
                        <p><strong>Hướng xử lý/Direction:</strong> ${
                          proposal.direction || "N/A"
                        }</p>
                        <p><strong>Tệp đính kèm/Attached File:</strong> ${
                          proposal.fileMetadata && proposal.fileMetadata.link
                            ? `<a href="${proposal.fileMetadata.link}" target="_blank">${proposal.fileMetadata.name}</a>`
                            : "Không có tệp đính kèm/No File Attached"
                        }</p>
                      </div>`
                  )
                  .join("")}
              </div>`;

            // Generate approvers HTML
            const approversHTML = doc.approvers
              .map(
                (approver) => `
                  <div class="approver">
                    <p>${approver.username} (${approver.subRole})</p>
                  </div>
                `
              )
              .join("");

            // File metadata
            const fileMetadataHTML = doc.fileMetadata
              ? `<a href="${doc.fileMetadata.link}" target="_blank">${doc.fileMetadata.name}</a>`
              : "Không có tệp đính kèm/No File Attached";

            // Generate the final row for the table
            const row = `
              <tr>
                <td>${doc._id}</td>
                <td>${productTable}</td>
                <td>${doc.grandTotalCost.toLocaleString()}</td>
                <td>${fileMetadataHTML}</td>
                <td>${appendedProposalsContent || "N/A"}</td>
                <td>${approversHTML}</td>
                <td>${doc.submittedBy.username} (${doc.submissionDate})</td>
                <td>
                  <form action="/exportDocumentToDocx/${
                    doc._id
                  }" method="GET" style="display:inline;" onsubmit="return confirmExport()">
                    <button type="submit">Xuất ra DOCX/Export to DOCX</button>
                  </form>
                </td>
              </tr>
            `;

            // Append the row to the table body
            purchasingTableBody.insertAdjacentHTML("beforeend", row);
          } else if (doc.title === "Payment Document") {
            let appendedPurchasingDocs = "N/A";
            let appendedProposalsContent = "N/A";

            if (
              doc.appendedPurchasingDocuments &&
              doc.appendedPurchasingDocuments.length > 0
            ) {
              // Process purchasing documents - horizontal layout
              appendedPurchasingDocs = `
                <div class="documents-container" style="display: flex; gap: 1rem; overflow: auto; padding-bottom: 1rem;">
                  ${doc.appendedPurchasingDocuments
                    .map((purchDoc) => {
                      // Process products
                      const products = purchDoc.products
                        .map(
                          (product) =>
                            `<li>
                                <strong>${product.productName}</strong><br>
                                Đơn giá/Cost Per Unit: ${product.costPerUnit.toLocaleString()}<br>
                                Số lượng/Amount: ${product.amount.toLocaleString()}<br>
                                Thành tiền/Total Cost: ${product.totalCost.toLocaleString()}<br>
                                Ghi chú/Notes: ${product.note || "None"}
                            </li>`
                        )
                        .join("");

                      // Handle file metadata
                      const fileMetadata = purchDoc.fileMetadata
                        ? `<p><strong>Tệp đính kèm phiếu mua hàng/File attaches to purchasing document:</strong> 
                            <a href="${purchDoc.fileMetadata.link}" target="_blank">${purchDoc.fileMetadata.name}</a></p>`
                        : "";

                      return `
                        <div class="purchasing-doc" style="flex: 0 0 300px; max-width: 300px; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
                          <p><strong>Tổng chi phí/Total Cost:</strong> ${purchDoc.grandTotalCost.toLocaleString()}</p>
                          <p><strong>Sản phẩm/Products:</strong></p>
                          <ul style="margin: 0; padding-left: 1.2rem;">${products}</ul>
                          ${fileMetadata}
                        </div>`;
                    })
                    .join("")}
                </div>`;

              // Process appended proposals separately - horizontal layout
              const allProposals = doc.appendedPurchasingDocuments
                .flatMap((purchDoc) => purchDoc.appendedProposals)
                .filter((proposal) => proposal); // Filter out any undefined/null proposals

              if (allProposals.length > 0) {
                appendedProposalsContent = `
                  <div class="proposals-container" style="display: flex; gap: 1rem; overflow: auto; padding-bottom: 1rem;">
                    ${allProposals
                      .map(
                        (proposal) =>
                          `<div class="proposal-card" style="flex: 0 0 300px; max-width: 300px; padding: 1rem; border: 1px solid #ddd; border-radius: 8px;">
                            <p><strong>Công việc/Task:</strong> ${
                              proposal.task
                            }</p>
                            <p><strong>Trạm/Center:</strong> ${
                              proposal.costCenter
                            }</p>
                            <p><strong>Mô tả/Description:</strong> ${
                              proposal.detailsDescription
                            }</p>
                            ${
                              proposal.fileMetadata
                                ? `<p><strong>Tệp đính kèm/File:</strong> 
                                   <a href="${proposal.fileMetadata.link}" target="_blank">${proposal.fileMetadata.name}</a></p>`
                                : ""
                            }
                          </div>`
                      )
                      .join("")}
                  </div>`;
              }
            }

            const row = paymentTableBody.insertRow();
            row.innerHTML = `
              <td>${doc._id}</td>
              <td>${doc.name}</td>
              <td>${doc.paymentMethod}</td>
              <td>${doc.amountOfMoney.toLocaleString()}</td>
              <td>${doc.paid.toLocaleString()}</td>
              <td>${doc.paymentDeadline}</td>
              <td>${appendedPurchasingDocs}</td>
              <td>${appendedProposalsContent}</td>
              <td>
                ${
                  doc.fileMetadata
                    ? `<a href="${doc.fileMetadata.link}" target="_blank">${doc.fileMetadata.name}</a>`
                    : "Không có tệp đính kèm/No File Attached"
                }
              </td>
              <td>${approversHTML}</td>
              <td>${doc.submittedBy.username} (${doc.submissionDate})</td>
              <td>
                  <form action="/exportDocumentToDocx/${
                    doc._id
                  }" method="GET" style="display:inline;" onsubmit="return confirmExport()">
                    <button type="submit">Xuất ra DOCX/Export to DOCX</button>
                  </form>
              </td>`;
          }
        });
      }

      function confirmExport() {
        return confirm(
          "Bạn có chắc muốn xuất phiếu này ra DOCX không?/Are you sure you want to export this document to DOCX?"
        );
      }

      fetchApprovedDocuments();
    </script>
  </body>
</html>
