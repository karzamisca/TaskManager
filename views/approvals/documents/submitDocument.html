<!-- views/approvals/documents/submitDocument.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Nộp phiếu/Submit Document</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <style>
      /* Base styles */
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background-color: #f8f9fa;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
        color: #333;
      }

      /* Container styling */
      .container {
        background: #fff;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        max-width: 800px;
        width: 100%;
      }

      /* Typography */
      h2 {
        margin-bottom: 1.5rem;
        font-size: 1.75rem;
        color: #2c3e50;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.75rem;
      }

      /* Form elements */
      label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
        font-weight: 500;
        color: #4a5568;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 1.25rem;
        border: 1.5px solid #e2e8f0;
        border-radius: 6px;
        font-size: 1rem;
        transition: all 0.2s ease;
        background-color: #fff;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #4299e1;
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
      }

      /* Buttons */
      button {
        width: 100%;
        padding: 0.75rem;
        background: #3182ce;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.2s ease;
        margin-bottom: 1rem;
      }

      button:hover {
        background: #2c5282;
        transform: translateY(-1px);
      }

      button:active {
        transform: translateY(0);
      }

      /* Secondary buttons */
      button[type="button"] {
        background: #718096;
        margin-bottom: 1.5rem;
      }

      button[type="button"]:hover {
        background: #4a5568;
      }

      /* Product entries section */
      #product-entries {
        background: #f8fafc;
        padding: 1.25rem;
        border-radius: 8px;
        margin-bottom: 1.25rem;
      }

      /* Approver selection styling */
      #approver-selection {
        margin: 1.5rem 0;
      }

      #approver-selection div {
        display: grid;
        grid-template-columns: auto 24px 1fr;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 6px;
      }

      #approver-selection input[type="checkbox"] {
        width: auto;
        margin: 0;
      }

      #approver-selection input[type="text"] {
        margin: 0;
      }

      /* Preview sections */
      #proposalPreview,
      #purchasingDocumentPreview {
        background: #f8fafc;
        padding: 1.25rem;
        border-radius: 8px;
        margin-top: 1rem;
      }

      /* Links */
      a {
        color: #3182ce;
        text-decoration: none;
        transition: color 0.2s ease;
      }

      a:hover {
        color: #2c5282;
        text-decoration: underline;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .container {
          padding: 1.5rem;
        }

        #approver-selection div {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }

        input,
        textarea,
        select {
          padding: 0.625rem;
        }

        h2 {
          font-size: 1.5rem;
        }
      }

      /* File input styling */
      input[type="file"] {
        padding: 0.5rem;
        border: 1.5px dashed #cbd5e0;
        background: #f8fafc;
      }

      input[type="file"]:hover {
        background: #edf2f7;
      }

      /* Flatpickr calendar customization */
      .flatpickr-calendar {
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      /* Error states */
      input:invalid,
      textarea:invalid,
      select:invalid {
        border-color: #27ae60;
      }

      /* Success states */
      input:valid:not(:placeholder-shown),
      textarea:valid:not(:placeholder-shown),
      select:valid:not(:placeholder-shown) {
        border-color: #27ae60;
      }

      /* Dark mode styles */
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #121212;
          color: #f1f1f1;
        }

        .container {
          background: #1e1e1e;
          color: #f1f1f1;
          box-shadow: 0 4px 6px rgba(255, 255, 255, 0.1),
            0 1px 3px rgba(255, 255, 255, 0.08);
        }

        h2 {
          color: #e0e0e0;
          border-bottom: 2px solid #333;
        }

        label {
          color: #cccccc;
        }

        input,
        textarea,
        select {
          background-color: #333;
          color: #f1f1f1;
          border: 1.5px solid #444;
        }

        input:focus,
        textarea:focus,
        select:focus {
          border-color: #90cdf4;
          box-shadow: 0 0 0 3px rgba(144, 205, 244, 0.3);
        }

        button {
          background: #2d3748;
          color: #f1f1f1;
        }

        button:hover {
          background: #4a5568;
        }

        button[type="button"] {
          background: #4a5568;
        }

        button[type="button"]:hover {
          background: #2d3748;
        }

        #product-entries,
        #approver-selection div,
        #proposalPreview,
        #purchasingDocumentPreview {
          background: #333;
          color: #f1f1f1;
        }

        a {
          color: #90cdf4;
        }

        a:hover {
          color: #63b3ed;
        }

        input[type="file"] {
          background: #333;
          border-color: #444;
        }

        input[type="file"]:hover {
          background: #444;
        }

        input:invalid,
        textarea:invalid,
        select:invalid {
          border-color: #68d391;
        }

        input:valid:not(:placeholder-shown),
        textarea:valid:not(:placeholder-shown),
        select:valid:not(:placeholder-shown) {
          border-color: #68d391;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Nộp phiếu mới/Submit New Document</h2>
      <form
        id="submit-form"
        action="/submitDocument"
        method="POST"
        enctype="multipart/form-data"
      >
        <label for="title">Title</label>
        <select name="title" id="title-dropdown" required>
          <option value="">Chọn mẫu phiếu/Select a title</option>
          <option value="Generic Document">Phiếu chung/Generic Document</option>
          <option value="Proposal Document">
            Phiếu đề xuất/Proposal Document
          </option>
          <option value="Purchasing Document">
            Phiếu mua hàng/Purchasing Document
          </option>
          <option value="Delivery Document">
            Phiếu xuất kho/Delivery Document
          </option>
          <option value="Payment Document">
            Phiếu thanh toán/Payment Document
          </option>
        </select>

        <!-- Content fields for Generic Document -->
        <div id="content-fields">
          <label for="contentName">Tên nội dung/Content Name</label>
          <input type="text" name="contentName" required />
          <label for="contentText">Nội dung/Content Text</label>
          <textarea name="contentText" rows="5" required></textarea>
        </div>

        <button type="button" id="add-content-btn">
          Thêm nội dung/Add More Content</button
        ><br />

        <label for="file">Đính kèm tệp/Attach File:</label>
        <input type="file" name="file" id="file" />

        <!-- Dropdown for appending approved documents, only visible for Generic Document -->
        <div id="append-approved-documents-section" style="display: none">
          <label for="approvedDocumentsDropdown"
            >Kèm phiếu đã duyệt/Append Approved Document</label
          >
          <select id="approvedDocumentsDropdown" name="approvedDocuments">
            <option value="">
              Chọn một phiếu đã duyệt/Select an approved document
            </option>
          </select>
        </div>

        <!-- Fields for selecting and previewing approved proposal document -->
        <div id="approved-proposal-section" style="display: none">
          <label for="approvedProposals"
            >Chọn phiếu đề xuất đã duyệt/Select Approved Proposal
            Documents</label
          >
          <div id="proposal-selections">
            <div class="proposal-entry"></div>
          </div>
          <button type="button" onclick="addProposalEntry()">
            Thêm phiếu đề xuất/Add Another Proposal
          </button>
          <div id="proposalPreviews"></div>
        </div>

        <!-- Dropdown for selecting Purchasing Document to append -->
        <div id="append-purchasing-documents-section" style="display: none">
          <label for="purchasingDocumentsDropdown">
            Chọn phiếu mua hàng để kèm theo/Select a Purchasing Document to
            Append
          </label>
          <select id="purchasingDocumentsDropdown">
            <option value="">
              Chọn phiếu mua hàng để kèm theo/Select a purchasing document
            </option>
            <!-- Options populated dynamically -->
          </select>
          <button type="button" id="add-purchasing-document-btn">
            Thêm phiếu mua hàng kèm theo /Append purchasing document
          </button>
        </div>

        <!-- List of appended purchasing documents -->
        <div id="appendedPurchasingDocumentsList">
          <ul id="purchasingDocumentsList"></ul>
        </div>

        <!-- Preview of the selected Purchasing Document -->
        <div id="purchasingDocumentPreview" style="display: none">
          <h3>
            Xem trước phiếu mua hàng đi kèm/Preview of Purchasing Document
          </h3>
          <p><strong>Thông tin sản phẩm/Product Details:</strong></p>
          <div id="productDetails"></div>
          <div id="appendedContentDetails"></div>
        </div>

        <!-- Approvers selection -->
        <label for="approvers">Chọn người phê duyệt/Select Approvers</label>
        <div id="approver-selection"></div>

        <button type="submit">Nộp phiếu/Submit Document</button><br />
        <a href="/mainDocument">Trở về/Back</a><br />
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
      flatpickr("#dateOfError", {
        dateFormat: "d-m-Y",
        defaultDate: "today",
      });

      document
        .getElementById("title-dropdown")
        .addEventListener("change", function () {
          const selectedTitle = this.value;
          const contentFields = document.getElementById("content-fields");
          const addContentButton = document.getElementById("add-content-btn");
          const approvedProposalSection = document.getElementById(
            "approved-proposal-section"
          );
          const appendApprovedDocumentsSection = document.getElementById(
            "append-approved-documents-section"
          );
          const appendPurchasingSection = document.getElementById(
            "append-purchasing-documents-section"
          );
          const purchasingDocumentPreview = document.getElementById(
            "purchasingDocumentPreview"
          );

          contentFields.innerHTML = "";
          addContentButton.style.display = "none";
          approvedProposalSection.style.display = "none";
          appendApprovedDocumentsSection.style.display = "none";
          appendPurchasingSection.style.display = "none";
          purchasingDocumentPreview.style.display = "none";

          if (selectedTitle === "Proposal Document") {
            // Create the base structure without the <select> options
            contentFields.innerHTML = `
              <label for="task">Công việc/Task</label>
              <input type="text" name="task" required />
              <label for="costCenter">Trạm/Center</label>
              <select name="costCenter" id="costCenter" required>
                <option value="">Chọn một trạm/Select a center</option>
                <!-- Options will be added here dynamically -->
              </select>
              <label for="dateOfError">Ngày xảy ra lỗi/Date of Error</label>
              <input type="text" name="dateOfError" id="dateOfError" required />
              <label for="detailsDescription">Mô tả chi tiết/Details Description</label>
              <textarea name="detailsDescription" rows="3" required></textarea>
              <label for="direction">Hướng xử lý/Direction</label>
              <input type="text" name="direction" required />
              <select name="groupName" id="groupName">
                <option value="">Chọn nhóm/Select a group</option>
              </select>
            `;
            populateGroupDropdown();

            // Fetch current user information
            fetch("/getCurrentUser")
              .then((response) => response.json())
              .then((userData) => {
                const currentUser = userData.username; // Get the current user's username

                // Fetch cost centers
                fetch("/costCenters")
                  .then((response) => response.json())
                  .then((costCenters) => {
                    const costCenterSelect =
                      document.getElementById("costCenter");

                    // Clear the existing options (if any)
                    costCenterSelect.innerHTML =
                      '<option value="">Chọn một trạm/Select a center</option>';

                    // Add options dynamically based on the allowed users
                    costCenters.forEach((center) => {
                      if (
                        center.allowedUsers.length === 0 ||
                        center.allowedUsers.includes(currentUser)
                      ) {
                        const option = document.createElement("option");
                        option.value = center.name;
                        option.textContent = center.name;
                        costCenterSelect.appendChild(option);
                      }
                    });
                  })
                  .catch((error) => {
                    console.error("Error fetching cost centers:", error);
                  });
              })
              .catch((error) => {
                console.error("Error fetching current user:", error);
              });

            flatpickr("#dateOfError", {
              dateFormat: "d-m-Y",
              defaultDate: "today",
            });

            addContentButton.style.display = "none";
          } else if (selectedTitle === "Purchasing Document") {
            contentFields.innerHTML = `
              <label for="name">Tên/Name</label>
              <input type="text" name="name" required />
              <label for="costCenter">Trạm/Center</label>
              <select name="costCenter" id="costCenter" required>
                <option value="">Chọn một trạm/Select a center</option>
              </select>            
              <div id="product-entries">
                <label>Tên sản phẩm/Product Name</label><input type="text" name="products[0][productName]" required />
                <label>Đơn giá/Cost per Unit</label><input type="number" step="0.01" name="products[0][costPerUnit]" required />
                <label>Số lượng/Amount</label><input type="number" name="products[0][amount]" required />
                <label>Thuế/Vat (%)</label><input type="number" name="products[0][vat]" required />
                <label>Ghi chú/Note</label><input type="text" name="products[0][note]" />
              </div>
              <button type="button" onclick="addProductEntry()">Thêm sản phẩm/Add More Products</button>
              <select name="groupName" id="groupName">
                <option value="">Chọn nhóm/Select a group</option>
              </select>
            `;
            populateGroupDropdown();
            approvedProposalSection.style.display = "block";

            // Fetch current user information and populate cost centers
            fetch("/getCurrentUser")
              .then((response) => response.json())
              .then((userData) => {
                const currentUser = userData.username;

                // Fetch cost centers
                fetch("/costCenters")
                  .then((response) => response.json())
                  .then((costCenters) => {
                    const costCenterSelect =
                      document.getElementById("costCenter");
                    costCenterSelect.innerHTML =
                      '<option value="">Chọn một trạm/Select a center</option>';

                    costCenters.forEach((center) => {
                      if (
                        center.allowedUsers.length === 0 ||
                        center.allowedUsers.includes(currentUser)
                      ) {
                        const option = document.createElement("option");
                        option.value = center.name;
                        option.textContent = center.name;
                        costCenterSelect.appendChild(option);
                      }
                    });
                  })
                  .catch((error) => {
                    console.error("Error fetching cost centers:", error);
                  });
              })
              .catch((error) => {
                console.error("Error fetching current user:", error);
              });
          } else if (selectedTitle === "Payment Document") {
            appendPurchasingSection.style.display = "block"; // Show dropdown for Purchasing Document
            fetchPurchasingDocuments(); // Fetch available Purchasing Documents
            // Add fields for Payment Document
            contentFields.innerHTML = `
              <label for="name">Tên/Name</label>
              <input type="text" name="name" required />
              <label for="content">Nội dung/Content</label>
              <input type="text" name="content" required />
              <label for="paymentMethod">Hình thức thanh toán/Payment Method</label>
              <input type="text" name="paymentMethod" required />
              <label for="totalPayment">Tổng thanh toán/Total Payment:</label>
              <input type="number" step="0.01" name="totalPayment" required />
              <label for="advancePayment">Thanh toán trước/Advance Payment:</label>
              <input type="number" step="0.01" name="advancePayment"/>
              <label for="paymentDeadline">Thời hạn trả/Payment Deadline</label>
              <input type="text" name="paymentDeadline" id="paymentDeadline" required />
              <select name="groupName" id="groupName">
                <option value="">Chọn nhóm/Select a group</option>
              </select>
            `;
            populateGroupDropdown();
            flatpickr("#paymentDeadline", {
              dateFormat: "d-m-Y",
              defaultDate: "today",
            });
          } else if (selectedTitle === "Delivery Document") {
            contentFields.innerHTML = `
              <label for="name">Tên/Name</label>
              <input type="text" name="name" required />
              <label for="costCenter">Trạm/Center</label>
              <select name="costCenter" id="costCenter" required>
                <option value="">Chọn một trạm/Select a center</option>
              </select>
              <div id="product-entries">
                <label>Tên sản phẩm/Product Name</label><input type="text" name="products[0][productName]" required />
                <label>Đơn giá/Cost per Unit</label><input type="number" step="0.01" name="products[0][costPerUnit]" required />
                <label>Số lượng/Amount</label><input type="number" name="products[0][amount]" required />
                <label>Thuế/Vat (%)</label><input type="number" name="products[0][vat]" required />
                <label>Ghi chú/Note</label><input type="text" name="products[0][note]" />
              </div>
              <button type="button" onclick="addProductEntry()">Thêm sản phẩm/Add More Products</button>
              <select name="groupName" id="groupName">
                <option value="">Chọn nhóm/Select a group</option>
              </select>
            `;

            populateGroupDropdown();
            approvedProposalSection.style.display = "block";

            // Fetch current user information and populate cost centers
            fetch("/getCurrentUser")
              .then((response) => response.json())
              .then((userData) => {
                const currentUser = userData.username;

                // Fetch cost centers
                fetch("/costCenters")
                  .then((response) => response.json())
                  .then((costCenters) => {
                    const costCenterSelect =
                      document.getElementById("costCenter");
                    costCenterSelect.innerHTML =
                      '<option value="">Chọn một trạm/Select a center</option>';

                    costCenters.forEach((center) => {
                      if (
                        center.allowedUsers.length === 0 ||
                        center.allowedUsers.includes(currentUser)
                      ) {
                        const option = document.createElement("option");
                        option.value = center.name;
                        option.textContent = center.name;
                        costCenterSelect.appendChild(option);
                      }
                    });
                  })
                  .catch((error) => {
                    console.error("Error fetching cost centers:", error);
                  });
              })
              .catch((error) => {
                console.error("Error fetching current user:", error);
              });
          } else if (selectedTitle === "Generic Document") {
            contentFields.innerHTML = `
              <label for="contentName">Tên nội dung/Content Name</label>
              <input type="text" name="contentName" required />
              <label for="contentText">Nội dung/Content Text</label>
              <textarea name="contentText" rows="5" required></textarea>
              <select name="groupName" id="groupName">
                <option value="">Chọn nhóm/Select a group</option>
              </select>
            `;
            populateGroupDropdown();
            addContentButton.style.display = "inline-block";
            appendApprovedDocumentsSection.style.display = "none";
          }
        });

      function addProductEntry() {
        const productEntries = document.getElementById("product-entries");
        const productCount = productEntries.children.length / 5;

        const newEntry = `
          <label>Tên sản phẩm/Product Name</label><input type="text" name="products[${productCount}][productName]" required />
          <label>Đơn giá/Cost per Unit</label><input type="number" name="products[${productCount}][costPerUnit]" required />
          <label>Số lượng/Amount</label><input type="number" name="products[${productCount}][amount]" required />
          <label>Thuế/Vat</label><input type="number" name="products[${productCount}][vat]" required />
          <label>Ghi chú/Note</label><input type="text" name="products[${productCount}][note]" />
        `;
        productEntries.insertAdjacentHTML("beforeend", newEntry);
      }

      async function fetchApprovers() {
        const response = await fetch("/approvers");
        const approvers = await response.json();
        const approverSelect = document.getElementById("approver-selection");

        approvers.forEach((approver) => {
          const approverDiv = document.createElement("div");
          const label = document.createElement("label");
          label.textContent = approver.username;
          approverDiv.appendChild(label);

          const approverInput = document.createElement("input");
          approverInput.type = "checkbox";
          approverInput.name = "approvers";
          approverInput.value = approver._id;
          approverDiv.appendChild(approverInput);

          const subRoleInput = document.createElement("input");
          subRoleInput.type = "text";
          subRoleInput.name = `subRole_${approver._id}`;
          subRoleInput.placeholder = "Nhập vai trò/Enter Sub-Role";
          subRoleInput.disabled = true;
          approverDiv.appendChild(subRoleInput);

          approverInput.addEventListener("change", function () {
            subRoleInput.disabled = !approverInput.checked;
            subRoleInput.required = approverInput.checked;
          });

          approverSelect.appendChild(approverDiv);
        });
      }

      async function fetchApprovedDocuments() {
        const response = await fetch("/approvedDocument");
        const approvedDocs = await response.json();
        const approvedDocsDropdown = document.getElementById(
          "approvedDocumentsDropdown"
        );

        approvedDocs.forEach((doc) => {
          const option = document.createElement("option");
          option.value = doc._id;
          option.textContent = doc._id;
          approvedDocsDropdown.appendChild(option);
        });
      }

      function addProposalEntry() {
        const container = document.getElementById("proposal-selections");
        const newEntry = document.createElement("div");
        newEntry.className = "proposal-entry";
        newEntry.innerHTML = `
          <select class="approved-proposal-dropdown" name="approvedProposals[]" onchange="previewProposalContent(this)">
            <option value="">Chọn phiếu đề xuất/Select a proposal</option>
          </select>
          <button type="button" class="remove-proposal" onclick="removeProposalEntry(this)">Xóa/Remove</button>
        `;
        container.appendChild(newEntry);
        // Populate the new dropdown
        fetchApprovedProposals(newEntry.querySelector("select"));
      }

      function removeProposalEntry(button) {
        const entry = button.parentElement;
        const previewId = entry.querySelector("select").value;
        if (previewId) {
          const previewElement = document.getElementById(
            `preview-${previewId}`
          );
          if (previewElement) previewElement.remove();
        }
        entry.remove();
      }

      async function fetchApprovedProposals(dropdown = null) {
        const response = await fetch("/approvedProposalDocuments");
        const approvedProposals = await response.json();

        if (!dropdown) {
          // If no specific dropdown provided, populate all dropdowns
          document
            .querySelectorAll(".approved-proposal-dropdown")
            .forEach((select) => {
              populateDropdown(select, approvedProposals);
            });
        } else {
          populateDropdown(dropdown, approvedProposals);
        }
      }

      function populateDropdown(select, proposals) {
        select.innerHTML =
          '<option value="">Chọn phiếu đề xuất/Select a proposal</option>';
        proposals.forEach((doc) => {
          const option = document.createElement("option");
          option.value = doc._id;
          option.textContent = doc.task;
          select.appendChild(option);
        });
      }

      async function previewProposalContent(selectElement) {
        const documentId = selectElement.value;
        const previewsContainer = document.getElementById("proposalPreviews");

        // Find the specific preview container for this select element
        const selectContainer = selectElement.closest(".proposal-entry");
        const existingPreview =
          selectContainer.querySelector(".proposal-preview");
        if (existingPreview) {
          existingPreview.remove();
        }

        if (!documentId) return;

        const response = await fetch(`/proposalDocument/${documentId}`);
        const proposal = await response.json();

        const previewDiv = document.createElement("div");
        previewDiv.className = "proposal-preview";
        previewDiv.innerHTML = `
          <h3>Xem trước phiếu đề xuất/Preview of Proposal ${documentId}</h3>
          <p><strong>Công việc/Task:</strong> ${proposal.task}</p>
          <p><strong>Trạm/Center:</strong> ${proposal.costCenter}</p>
          <p><strong>Ngày xảy ra lỗi/Date of Error:</strong> ${
            proposal.dateOfError
          }</p>
          <p><strong>Mô tả chi tiết/Details Description:</strong> ${
            proposal.detailsDescription
          }</p>
          <p><strong>Hướng xử lý/Direction:</strong> ${proposal.direction}</p>
          ${
            proposal.fileMetadata
              ? `<p><strong>Tệp đính kèm/Attached File:</strong> 
            <a href="${proposal.fileMetadata.link}" target="_blank">${proposal.fileMetadata.name}</a></p>`
              : ""
          }
        `;
        // Insert the preview right after the select container
        selectContainer.appendChild(previewDiv);
      }

      async function fetchPurchasingDocuments() {
        const response = await fetch("/approvedPurchasingDocuments");
        const purchasingDocs = await response.json();
        const dropdown = document.getElementById("purchasingDocumentsDropdown");

        // Populate dropdown options
        dropdown.innerHTML =
          '<option value="">Hãy chọn một phiếu mua hàng/Select a purchasing document</option>';
        purchasingDocs.forEach((doc) => {
          const option = document.createElement("option");
          option.value = doc._id;
          option.textContent = doc.submissionDate;
          dropdown.appendChild(option);
        });
      }

      // Add selected purchasing document to the list
      document
        .getElementById("add-purchasing-document-btn")
        .addEventListener("click", async () => {
          const dropdown = document.getElementById(
            "purchasingDocumentsDropdown"
          );
          const selectedDocId = dropdown.value;
          const purchasingDocumentsList = document.getElementById(
            "purchasingDocumentsList"
          );

          if (!selectedDocId) {
            alert(
              "Xin hãy chọn phiếu mua hàng/Please select a purchasing document."
            );
            return;
          }

          // Check if the document is already added
          if (document.querySelector(`#doc-${selectedDocId}`)) {
            alert(
              "Bạn đã thêm phiếu này rồi/This document has already been added."
            );
            return;
          }

          // Fetch and display the purchasing document details
          try {
            const response = await fetch(
              `/purchasingDocument/${selectedDocId}`
            );
            if (!response.ok)
              throw new Error("Failed to fetch document details.");
            const doc = await response.json();

            const listItem = document.createElement("li");
            listItem.id = `doc-${selectedDocId}`;
            listItem.innerHTML = `
              <strong>Mã/ID:</strong> ${doc._id}<br>
              <strong>Tình trạng phê duyệt/Approval Status:</strong> ${
                doc.approved
                  ? "Đã phê duyệt/Approved"
                  : "Chưa phê duyệt/Pending"
              }<br>
              <strong>Chi phí/Grand Total Cost:</strong> ${doc.grandTotalCost.toLocaleString()}<br>
              <h3>Sản phẩm/Products:</h3>
              <ul>
                  ${doc.products
                    .map(
                      (product) => `
                              <li>
                                  <strong>${product.productName}</strong><br>
                                  Đơn giá/Cost Per Unit: ${product.costPerUnit.toLocaleString()}<br>
                                  Số lượng/Amount: ${product.amount.toLocaleString()}<br>
                                  Thuế/Vat (%): ${product.vat.toLocaleString()}<br>
                                  Thành tiền/Total Cost: ${product.totalCost.toLocaleString()}<br>
                                  Thành tiền sau thuế/Total Cost After Vat: ${product.totalCostAfterVat.toLocaleString()}<br>
                                  Ghi chú/Notes: ${product.note || "None"}
                              </li>
                          `
                    )
                    .join("")}
              </ul>
              <h2>Các phiếu đề xuất đính kèm/Appended Proposals:</h2>
              ${
                doc.appendedProposals.length > 0
                  ? doc.appendedProposals
                      .map(
                        (proposal) => `
                                    <li>
                                      <strong>${proposal.task}</strong><br>
                                      Trạm/Center: ${proposal.costCenter}<br>
                                      Ngày xảy ra lỗi/Date of Error: ${
                                        proposal.dateOfError
                                      }<br>
                                      Mô tả chi tiết/Details Description: ${
                                        proposal.detailsDescription
                                      } <br>
                                      Hướng xử lý/Direction: ${
                                        proposal.direction
                                      }<br>
                                      ${
                                        proposal.fileMetadata
                                          ? `Tệp đính kèm phiếu đề xuất/Attached File to Proposal Document: 
                                              <a href="${proposal.fileMetadata.link}" target="_blank">${proposal.fileMetadata.name}</a>`
                                          : ""
                                      }<br>
                                    </li>
                                `
                      )
                      .join("")
                  : "<p>Không có phiếu đề xuất đính kèm/No appended proposals.</p>"
              }
              ${
                doc.fileMetadata
                  ? `<p><strong>Tệp đính kèm phiếu thanh toán/File attaches to payment document:</strong> 
                        <a href="${doc.fileMetadata.link}" target="_blank">${doc.fileMetadata.name}</a></p>`
                  : "<p>Không có tệp đính kèm/No file attached.</p>"
              }
              <button type="button" onclick="removePurchasingDocument('${selectedDocId}')">Xóa/Remove</button>
          `;

            purchasingDocumentsList.appendChild(listItem);

            // Add hidden input for form submission
            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = "approvedPurchasingDocuments[]";
            hiddenInput.value = selectedDocId;
            hiddenInput.id = `input-${selectedDocId}`;
            document.getElementById("submit-form").appendChild(hiddenInput);
          } catch (error) {
            console.error("Error fetching document details:", error);
            alert("Failed to add the purchasing document. Please try again.");
          }
        });

      // Remove a purchasing document
      function removePurchasingDocument(docId) {
        document.getElementById(`doc-${docId}`).remove();
        document.getElementById(`input-${docId}`).remove();
      }

      async function fetchGroups() {
        try {
          const response = await fetch("/getGroupDocument");
          const groups = await response.json();
          return groups;
        } catch (error) {
          console.error("Error fetching groups:", error);
          return [];
        }
      }

      async function populateGroupDropdown() {
        const groups = await fetchGroups();
        const groupSelect = document.getElementById("groupName");

        // Clear existing options except the first one
        groupSelect.innerHTML =
          '<option value="">Chọn nhóm/Select a group</option>';

        // Add new options
        groups.forEach((group) => {
          const option = document.createElement("option");
          option.value = group.name;
          option.textContent = group.name;
          groupSelect.appendChild(option);
        });
      }

      fetchApprovedDocuments();
      fetchApprovers();
      fetchApprovedProposals();
      fetchPurchasingDocuments();

      document
        .getElementById("submit-form")
        .addEventListener("submit", function (event) {
          const approvers = document.querySelectorAll(
            'input[name="approvers"]:checked'
          );
          if (approvers.length === 0) {
            event.preventDefault();
            alert(
              "Xin hãy chọn ít nhất một người phê duyệt/Please select at least one approver."
            );
          }
        });

      document
        .getElementById("add-content-btn")
        .addEventListener("click", function () {
          const contentFields = document.getElementById("content-fields");
          const nameLabel = document.createElement("label");
          nameLabel.innerText = "Tên nội dung/Content Name";
          const nameInput = document.createElement("input");
          nameInput.type = "text";
          nameInput.name = "contentName";

          const textLabel = document.createElement("label");
          textLabel.innerText = "Nội dung/Content Text";
          const textArea = document.createElement("textarea");
          textArea.name = "contentText";
          textArea.rows = 5;

          contentFields.appendChild(nameLabel);
          contentFields.appendChild(nameInput);
          contentFields.appendChild(textLabel);
          contentFields.appendChild(textArea);
        });
    </script>
  </body>
</html>
