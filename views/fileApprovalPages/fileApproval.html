<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NextCloud File Upload</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .upload-section,
      .pending-files,
      .history {
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
      }
      .file-item:hover {
        background-color: #f9f9f9;
      }
      .file-info {
        flex: 1;
      }
      .file-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
      }
      .btn-approve {
        background-color: #28a745;
        color: white;
      }
      .btn-approve:hover {
        background-color: #218838;
      }
      .btn-reject {
        background-color: #dc3545;
        color: white;
      }
      .btn-reject:hover {
        background-color: #c82333;
      }
      .btn-view {
        background-color: #17a2b8;
        color: white;
        text-decoration: none;
        display: inline-block;
      }
      .btn-view:hover {
        background-color: #138496;
      }
      .btn:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .status-pending {
        color: #ffc107;
        font-weight: bold;
      }
      .status-approved {
        color: #28a745;
        font-weight: bold;
      }
      .status-rejected {
        color: #dc3545;
        font-weight: bold;
      }
      .file-name {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 5px;
      }
      .file-details {
        color: #666;
        font-size: 14px;
      }
      .upload-area {
        border: 2px dashed #ddd;
        padding: 40px;
        text-align: center;
        border-radius: 8px;
        margin-bottom: 20px;
        transition: border-color 0.3s;
      }
      .upload-area:hover {
        border-color: #007bff;
      }
      .upload-area.dragover {
        border-color: #007bff;
        background-color: #f8f9fa;
      }
      #uploadMessage {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
    </style>
  </head>
  <body>
    <h1>NextCloud File Upload System</h1>

    <!-- File Upload Section -->
    <div class="upload-section">
      <h2>Upload File</h2>
      <div class="upload-area" id="uploadArea">
        <p>Drag and drop your file here or click to browse</p>
        <form id="uploadForm" enctype="multipart/form-data">
          <input
            type="file"
            name="file"
            id="fileInput"
            style="display: none"
            required
          />
          <button
            type="button"
            class="btn"
            onclick="document.getElementById('fileInput').click()"
          >
            Browse Files
          </button>
        </form>
      </div>
      <div id="uploadMessage"></div>
    </div>

    <!-- Pending Files Section -->
    <div class="pending-files">
      <h2>Pending Files</h2>
      <button
        onclick="loadPendingFiles()"
        class="btn"
        style="background-color: #007bff; color: white"
      >
        Refresh List
      </button>
      <div id="pendingFilesList" style="margin-top: 20px"></div>
    </div>

    <!-- History Section -->
    <div class="history">
      <h2>File History</h2>
      <button
        onclick="loadHistory()"
        class="btn"
        style="background-color: #6c757d; color: white"
      >
        Load History
      </button>
      <div id="historyList" style="margin-top: 20px"></div>
    </div>

    <script>
      // Drag and drop functionality
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          handleFileUpload();
        }
      });

      fileInput.addEventListener("change", handleFileUpload);

      // Upload form handler
      async function handleFileUpload() {
        if (fileInput.files.length === 0) {
          return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        showMessage("Uploading file...", "info");

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            showMessage(
              "File uploaded successfully to Pending folder! You can view it using the link below.",
              "success"
            );
            if (result.shareUrl) {
              showMessage(
                `<a href="${result.shareUrl}" target="_blank" class="btn btn-view">View Uploaded File</a>`,
                "success"
              );
            }
            fileInput.value = "";
            loadPendingFiles();
          } else {
            showMessage("Upload failed: " + result.error, "error");
          }
        } catch (error) {
          showMessage("Upload failed: " + error.message, "error");
        }
      }

      // Load pending files
      async function loadPendingFiles() {
        try {
          const response = await fetch("/files/pending");
          const files = await response.json();

          const filesList = document.getElementById("pendingFilesList");
          filesList.innerHTML = "";

          if (files.length === 0) {
            filesList.innerHTML =
              '<p style="text-align: center; color: #666;">No pending files</p>';
            return;
          }

          files.forEach((file) => {
            const fileElement = document.createElement("div");
            fileElement.className = "file-item";
            fileElement.innerHTML = `
                        <div class="file-info">
                            <div class="file-name">${file.originalName}</div>
                            <div class="file-details">
                                Size: ${formatFileSize(file.fileSize)} | 
                                Uploaded: ${new Date(
                                  file.uploadedAt
                                ).toLocaleString()} |
                                By: ${file.uploadedBy || "Anonymous"}
                            </div>
                            ${
                              file.shareUrl
                                ? `<a href="${file.shareUrl}" target="_blank" class="btn btn-view" style="margin-top: 5px;">View File</a>`
                                : ""
                            }
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-approve" onclick="approveFile('${
                              file._id
                            }')">Approve</button>
                            <button class="btn btn-reject" onclick="rejectFile('${
                              file._id
                            }')">Reject</button>
                        </div>
                    `;
            filesList.appendChild(fileElement);
          });
        } catch (error) {
          console.error("Error loading pending files:", error);
          showMessage("Error loading pending files: " + error.message, "error");
        }
      }

      // Load history
      async function loadHistory() {
        try {
          const response = await fetch("/files/history");
          const files = await response.json();

          const historyList = document.getElementById("historyList");
          historyList.innerHTML = "";

          if (files.length === 0) {
            historyList.innerHTML =
              '<p style="text-align: center; color: #666;">No history available</p>';
            return;
          }

          files.forEach((file) => {
            const fileElement = document.createElement("div");
            fileElement.className = "file-item";
            fileElement.innerHTML = `
                        <div class="file-info">
                            <div class="file-name">${file.originalName}</div>
                            <div class="file-details">
                                Status: <span class="status-${
                                  file.status
                                }">${file.status.toUpperCase()}</span> | 
                                Size: ${formatFileSize(file.fileSize)} | 
                                Action: ${file.actionTakenBy} at ${new Date(
              file.actionTakenAt
            ).toLocaleString()}
                                ${
                                  file.shareUrl
                                    ? `<br><a href="${file.shareUrl}" target="_blank" class="btn btn-view" style="margin-top: 5px;">View in NextCloud</a>`
                                    : ""
                                }
                            </div>
                        </div>
                    `;
            historyList.appendChild(fileElement);
          });
        } catch (error) {
          console.error("Error loading history:", error);
          showMessage("Error loading history: " + error.message, "error");
        }
      }

      // Approve file
      async function approveFile(fileId) {
        if (
          !confirm(
            "Are you sure you want to approve this file? It will be moved to the Approved folder."
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`/files/${fileId}/approve`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();

          if (result.success) {
            showMessage(
              "File approved and moved to Approved folder!",
              "success"
            );
            loadPendingFiles();
            loadHistory();
          } else {
            showMessage("Approval failed: " + result.error, "error");
          }
        } catch (error) {
          showMessage("Approval failed: " + error.message, "error");
        }
      }

      // Reject file
      async function rejectFile(fileId) {
        if (
          !confirm(
            "Are you sure you want to reject this file? It will be permanently deleted from NextCloud."
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`/files/${fileId}/reject`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();

          if (result.success) {
            showMessage("File rejected and deleted from NextCloud.", "success");
            loadPendingFiles();
            loadHistory();
          } else {
            showMessage("Rejection failed: " + result.error, "error");
          }
        } catch (error) {
          showMessage("Rejection failed: " + error.message, "error");
        }
      }

      // Utility functions
      function showMessage(message, type) {
        const messageDiv = document.getElementById("uploadMessage");
        messageDiv.innerHTML = message;
        messageDiv.className = type;
        setTimeout(() => {
          messageDiv.innerHTML = "";
          messageDiv.className = "";
        }, 10000);
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // Load pending files on page load
      loadPendingFiles();
    </script>
  </body>
</html>
